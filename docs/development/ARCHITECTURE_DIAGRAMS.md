# Architecture Diagrams

## NixOS AI Stack Architecture

### High-Level Architecture
```
┌─────────────────────────────────────────────────────────────┐
│                    Client Layer                             │
├─────────────────────────────────────────────────────────────┤
│  Dashboard UI    │  MCP Clients   │  External Agents      │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   API Gateway Layer                         │
├─────────────────────────────────────────────────────────────┤
│  Dashboard API   │  AIDB MCP      │  Hybrid Coordinator   │
│      8889        │     8091       │         8092          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   Service Layer                             │
├─────────────────────────────────────────────────────────────┤
│  AIDB    │  Embeddings  │  Ralph   │  NixOS Docs         │
│  8091     │    8081      │  8098    │    8094            │
├─────────────────────────────────────────────────────────────┤
│  Llama.cpp  │  Postgres  │  Redis   │  Qdrant            │
│    8080     │   5432     │   6379   │   6333            │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                 Infrastructure Layer                        │
├─────────────────────────────────────────────────────────────┤
│              Kubernetes (K3s) Cluster                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │   ai-stack  │ │  monitoring │ │   backups   │         │
│  │  namespace  │ │  namespace  │ │  namespace  │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### MCP Server Architecture
```
┌─────────────────────────────────────────┐
│           MCP Client                    │
│    (AI Agents, Dashboard, etc.)         │
└─────────────────┬───────────────────────┘
                  │ HTTP/HTTPS
┌─────────────────▼───────────────────────┐
│            MCP Server                   │
│  ┌───────────────────────────────────┐  │
│  │  Authentication & Authorization   │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │     Request Validation            │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │     Business Logic                │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │     Response Formatting           │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### Data Flow Architecture
```
External Request → Authentication → Validation → Processing → Response
      ↓              ↓              ↓           ↓           ↓
   AIDB API ←─── Discovery API ←── RAG ←─── Embeddings ───→ Client
      ↓              ↓              ↓           ↓
   PostgreSQL ←─── Redis ←────── Qdrant ←─── Vector Store
```