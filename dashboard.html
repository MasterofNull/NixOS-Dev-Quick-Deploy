<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NixOS System Command Center</title>
    <script src="./assets/vendor/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Orbitron:wght@700;900&display=swap');

        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #111822;
            --bg-tertiary: #1a2332;
            --bg-card: #141d2b;
            --border-primary: #1e3a5f;
            --border-glow: #00d9ff;
            --text-primary: #e6f1ff;
            --text-secondary: #8892a6;
            --text-muted: #4a5568;
            --accent-cyan: #00d9ff;
            --accent-magenta: #ff006e;
            --accent-yellow: #ffbe0b;
            --status-online: #00ff88;
            --status-warning: #ffbe0b;
            --status-error: #ff006e;
            --scanline: rgba(0, 217, 255, 0.03);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated scanline effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                var(--scanline) 2px,
                var(--scanline) 4px
            );
            pointer-events: none;
            z-index: 9999;
            animation: scanlines 8s linear infinite;
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(8px); }
        }

        /* Glow effect */
        @keyframes glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .container {
            max-width: 2200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        header {
            margin-bottom: 3rem;
            border-bottom: 2px solid var(--border-primary);
            padding-bottom: 2rem;
            position: relative;
        }

        h1 {
            font-family: 'Orbitron', monospace;
            font-size: 3.5rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            animation: glow 3s ease-in-out infinite;
        }

        .header-meta {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 300;
        }

        .header-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--status-online);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 0 10px var(--status-online);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* Health Score */
        .health-score {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-glow);
            border-radius: 8px;
            padding: 1.5rem;
            min-width: 200px;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
        }

        .health-score-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .health-score-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-cyan);
            line-height: 1;
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1400px) {
            .dashboard-grid {
                grid-template-columns: repeat(3, minmax(360px, 1fr));
            }
        }

        .dashboard-section {
            grid-column: span 1;
        }

        .dashboard-section.full-width {
            grid-column: 1 / -1;
        }

        .dashboard-section.half-width {
            grid-column: span 1;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg,
                transparent,
                var(--border-glow),
                transparent
            );
            transform: translateX(-100%);
            animation: slide 3s ease-in-out infinite;
        }

        @keyframes slide {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .card:hover {
            border-color: var(--border-glow);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .card-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent-cyan);
        }

        .card-badge {
            background: var(--bg-tertiary);
            padding: 0.25rem 0.75rem;
            border-radius: 2px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 1px solid var(--border-primary);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .metric {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 4px;
            border-left: 3px solid var(--accent-cyan);
        }

        .metric-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1;
        }

        .metric-unit {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-left: 0.25rem;
        }

        /* Progress Bars */
        .progress-container {
            margin: 1rem 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta));
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Status Indicators */
        .status-grid {
            display: grid;
            gap: 0.75rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            padding: 0.75rem 1rem;
            border-radius: 4px;
            border-left: 3px solid var(--text-muted);
            transition: all 0.3s ease;
        }

        .status-item.online {
            border-left-color: var(--status-online);
        }

        .status-item.offline {
            border-left-color: var(--status-error);
        }

        .status-item.warning {
            border-left-color: var(--status-warning);
        }

        .status-label {
            font-size: 0.9rem;
            font-weight: 400;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 2px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .status-badge.online {
            background: rgba(0, 255, 136, 0.1);
            color: var(--status-online);
            border: 1px solid var(--status-online);
        }

        .status-badge.offline {
            background: rgba(255, 0, 110, 0.1);
            color: var(--status-error);
            border: 1px solid var(--status-error);
        }

        .status-badge.warning {
            background: rgba(255, 190, 11, 0.1);
            color: var(--status-warning);
            border: 1px solid var(--status-warning);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 0.5rem;
        }

        .chart-container.chart-disabled {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.02);
        }

        .chart-fallback {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
            padding: 0 1rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .hardware-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .hardware-block {
            display: grid;
            grid-template-columns: minmax(240px, 1fr) minmax(240px, 1fr);
            gap: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 1rem;
        }

        .hardware-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-cyan);
            margin-bottom: 0.75rem;
        }

        .chart-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .hardware-metrics {
            display: grid;
            gap: 0.75rem;
        }

        /* Quick Links */
        .links-grid {
            display: grid;
            gap: 0.5rem;
        }

        .data-list {
            display: grid;
            gap: 0.75rem;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .data-meta {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .link-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 4px;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .link-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-glow);
            transform: translateX(5px);
        }

        .link-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-cyan);
        }

        .link-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .link-path {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Collapsible */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .collapsible-arrow {
            transition: transform 0.3s ease;
        }

        .collapsible-header.collapsed .collapsible-arrow {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        /* Copy button */
        .copyable {
            cursor: pointer;
            position: relative;
            display: inline-block;
        }

        .copyable:hover {
            color: var(--accent-cyan);
        }

        .copyable::after {
            content: 'üìã';
            position: absolute;
            right: -1.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .copyable:hover::after {
            opacity: 1;
        }

        /* Export button */
        .export-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-glow);
            color: var(--accent-cyan);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: var(--border-glow);
            color: var(--bg-primary);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error state */
        .error {
            background: rgba(255, 0, 110, 0.1);
            border: 1px solid var(--status-error);
            padding: 1rem;
            border-radius: 4px;
            color: var(--status-error);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .health-score {
                position: static;
                margin-top: 1rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Search */
        .search-box {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--border-glow);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
        }

        /* Container list */
        .container-item {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--status-online);
        }

        .container-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .container-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Service Control Styles */
        .service-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            background: var(--bg-tertiary);
            transition: all 0.3s ease;
        }

        .service-item:hover {
            border-color: var(--border-glow);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.1);
        }

        .service-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .service-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .service-status-dot.running {
            background: var(--status-online);
            box-shadow: 0 0 10px var(--status-online);
        }

        .service-status-dot.stopped {
            background: var(--text-muted);
        }

        .service-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .service-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .service-type {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .service-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .service-status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .service-status-badge.running {
            background: rgba(0, 255, 136, 0.1);
            color: var(--status-online);
            border: 1px solid var(--status-online);
        }

        .service-status-badge.stopped {
            background: rgba(74, 85, 104, 0.1);
            color: var(--text-muted);
            border: 1px solid var(--text-muted);
        }

        .service-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s ease;
        }

        .service-btn:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--border-glow);
            transform: translateY(-1px);
        }

        .service-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .service-btn.start {
            border-color: var(--status-online);
        }

        .service-btn.stop {
            border-color: var(--status-error);
        }

        .service-btn.restart {
            border-color: var(--accent-yellow);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SYSTEM COMMAND CENTER</h1>
            <div class="header-meta">
                <div class="header-meta-item">
                    <div class="pulse-dot"></div>
                    <span>LIVE MONITORING ACTIVE</span>
                </div>
                <div class="header-meta-item">
                    <span>‚è± LAST UPDATE: <span id="lastUpdate">--:--:--</span></span>
                </div>
                <div class="header-meta-item">
                    <span>üñ•Ô∏è HOST: <span id="hostname" class="copyable">localhost</span></span>
                </div>
                <div class="header-meta-item">
                    <span>üß≠ MODE: <span id="runtimeMode" class="copyable">unknown</span></span>
                </div>
            </div>
            <div class="health-score">
                <div class="health-score-label">System Health</div>
                <div class="health-score-value" id="healthScore">--</div>
            </div>
        </header>

        <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-bottom: 1rem; align-items: center;">
            <span id="refreshStatus" style="font-size: 0.75rem; color: var(--text-muted);"></span>
            <button class="export-btn" onclick="refreshDashboard()">‚ü≥ Refresh Now</button>
            <button class="export-btn" onclick="exportData()">‚¨á Export JSON for AI</button>
        </div>

            <div class="dashboard-grid">
            <!-- System Overview -->
            <div class="dashboard-section full-width">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">System Overview (Host)</h2>
                        </div>
                        <span class="card-badge">Core Metrics</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="hardware-grid">
                            <div class="hardware-block">
                                <div>
                                    <div class="hardware-title">CPU</div>
                                    <div class="hardware-metrics">
                                        <div class="metric">
                                            <div class="metric-label">CPU Usage</div>
                                            <div class="metric-value" id="cpuUsage">--<span class="metric-unit">%</span></div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">CPU Model</div>
                                            <div class="metric-value" id="cpuModel">--</div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">CPU Temp</div>
                                            <div class="metric-value" id="cpuTemp">--</div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">Load Avg</div>
                                            <div class="metric-value copyable" id="loadAvg">--</div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">Arch</div>
                                            <div class="metric-value" id="cpuArch">--</div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="chart-title">CPU Usage Trend</div>
                                    <div class="chart-container">
                                        <canvas id="cpuChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="hardware-block">
                                <div>
                                    <div class="hardware-title">GPU</div>
                                    <div class="hardware-metrics">
                                        <div class="metric">
                                            <div class="metric-label">GPU</div>
                                            <div class="metric-value" id="gpuName">--</div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">GPU Busy</div>
                                            <div class="metric-value" id="gpuBusy">--</div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">VRAM</div>
                                            <div class="metric-value" id="gpuVram">--</div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="chart-title">GPU Usage Trend</div>
                                    <div class="chart-container">
                                        <canvas id="gpuChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="hardware-block">
                                <div>
                                    <div class="hardware-title">Memory</div>
                                    <div class="progress-container">
                                        <div class="progress-header">
                                            <span>Memory Utilization</span>
                                            <span id="memoryPercent">-- %</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="memoryBar" style="width: 0%"></div>
                                        </div>
                                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                                            <span id="memoryUsed">--</span> / <span id="memoryTotal">--</span> MB
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="chart-title">Memory Usage Trend</div>
                                    <div class="chart-container">
                                        <canvas id="memoryChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="hardware-block">
                                <div>
                                    <div class="hardware-title">Disk</div>
                                    <div class="progress-container">
                                        <div class="progress-header">
                                            <span>Disk Usage (/)</span>
                                            <span id="diskPercent">-- %</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="diskBar" style="width: 0%"></div>
                                        </div>
                                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                                            <span id="diskUsed">--</span> / <span id="diskTotal">--</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="chart-title">Disk Usage Trend</div>
                                    <div class="chart-container">
                                        <canvas id="diskChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="hardware-block">
                                <div>
                                    <div class="hardware-title">Network</div>
                                    <div class="hardware-metrics">
                                        <div class="metric">
                                            <div class="metric-label">Interface</div>
                                            <div class="metric-value copyable" id="netIface">--</div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">Download</div>
                                            <div class="metric-value" id="netRxRate">--</div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">Upload</div>
                                            <div class="metric-value" id="netTxRate">--</div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="chart-title">Network Traffic (KB/s)</div>
                                    <div class="chart-container">
                                        <canvas id="networkChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="hardware-block">
                                <div>
                                    <div class="hardware-title">System</div>
                                    <div class="hardware-metrics">
                                        <div class="metric">
                                            <div class="metric-label">Uptime</div>
                                            <div class="metric-value" id="uptime">--</div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="hardware-title">Host</div>
                                    <div class="hardware-metrics">
                                        <div class="metric">
                                            <div class="metric-label">Host</div>
                                            <div class="metric-value copyable" id="hostnameDetail">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Container System Overview -->
            <div class="dashboard-section full-width">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">System Overview (Container)</h2>
                        </div>
                        <span class="card-badge">Pod Metrics</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="hardware-grid">
                            <div class="hardware-block">
                                <div>
                                    <div class="hardware-title">CPU</div>
                                    <div class="hardware-metrics">
                                        <div class="metric">
                                            <div class="metric-label">CPU Usage</div>
                                            <div class="metric-value" id="containerCpuUsage">--<span class="metric-unit">%</span></div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">CPU Model</div>
                                            <div class="metric-value" id="containerCpuModel">--</div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">CPU Temp</div>
                                            <div class="metric-value" id="containerCpuTemp">--</div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">Load Avg</div>
                                            <div class="metric-value copyable" id="containerLoadAvg">--</div>
                                        </div>
                                        <div class="metric">
                                            <div class="metric-label">Arch</div>
                                            <div class="metric-value" id="containerCpuArch">--</div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="hardware-title">Memory</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="containerMemoryBar" style="width: 0%"></div>
                                    </div>
                                    <div class="progress-labels">
                                        <span>Used: <span id="containerMemoryUsed">--</span> GB</span>
                                        <span>Total: <span id="containerMemoryTotal">--</span> GB</span>
                                    </div>
                                    <div class="metric" style="margin-top: 0.75rem;">
                                        <div class="metric-label">Memory %</div>
                                        <div class="metric-value" id="containerMemoryPercent">--</div>
                                    </div>
                                </div>
                                <div>
                                    <div class="hardware-title">Storage</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill warning" id="containerDiskBar" style="width: 0%"></div>
                                    </div>
                                    <div class="progress-labels">
                                        <span>Used: <span id="containerDiskUsed">--</span> GB</span>
                                        <span>Total: <span id="containerDiskTotal">--</span> GB</span>
                                    </div>
                                    <div class="metric" style="margin-top: 0.75rem;">
                                        <div class="metric-label">Disk %</div>
                                        <div class="metric-value" id="containerDiskPercent">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="data-list" style="margin-top: 1rem;">
                            <div class="data-item">
                                <span>Container Hostname</span>
                                <span class="data-meta" id="containerHostname">--</span>
                            </div>
                            <div class="data-item">
                                <span>Container Uptime</span>
                                <span class="data-meta" id="containerUptime">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LLM Stack Status -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">AI Stack Status</h2>
                        </div>
                        <span class="card-badge" id="llmBadge">6 Services</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="status-grid" id="llmStatus">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">llama.cpp Cached Models</div>
                            <div class="data-list" id="llamaCachedModels">
                                <div class="data-item">
                                    <span>Cached GGUFs</span>
                                    <span class="data-meta">--</span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">Embedding Models (Cache)</div>
                            <div class="data-list" id="embeddingCachedModels">
                                <div class="data-item">
                                    <span>Sentence-Transformers</span>
                                    <span class="data-meta">--</span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">Embedding Service Usage</div>
                            <div class="data-list" id="embeddingUsage">
                                <div class="data-item">
                                    <span>Status</span>
                                    <span class="data-meta">--</span>
                                </div>
                                <div class="data-item">
                                    <span>Requests</span>
                                    <span class="data-meta">--</span>
                                </div>
                                <div class="data-item">
                                    <span>Errors</span>
                                    <span class="data-meta">--</span>
                                </div>
                                <div class="data-item">
                                    <span>Memory</span>
                                    <span class="data-meta">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agentic Readiness -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Agentic Readiness</h2>
                        </div>
                        <span class="card-badge">RAG & Learning</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="status-grid" id="agenticStatus">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">Embeddings Service</div>
                            <div id="embeddingsInfo" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AIDB Health Monitoring (P1/P2 Features) -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">AIDB Health & Security</h2>
                        </div>
                        <span class="card-badge" id="aidbHealthBadge">P1/P2 Hardening</span>
                    </div>
                    <div class="collapsible-content">
                        <!-- Health Probes Status -->
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">Service Health Probes</div>
                        <div class="status-grid" id="healthProbes">
                            <div class="status-item">
                                <span class="status-label">ü´Ä Liveness</span>
                                <span class="status-value" id="livenessProbe">--</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">‚úÖ Readiness</span>
                                <span class="status-value" id="readinessProbe">--</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">üöÄ Startup</span>
                                <span class="status-value" id="startupProbe">--</span>
                            </div>
                        </div>

                        <!-- Dependency Health -->
                        <div style="margin-top: 1.5rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">Dependency Health Checks</div>
                            <div class="data-list" id="dependencyHealth">
                                <div class="loading"><div class="spinner"></div></div>
                            </div>
                        </div>

                        <!-- Security & Performance Metrics -->
                        <div style="margin-top: 1.5rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">Security & Performance (P1 Features)</div>
                            <div class="metrics-grid">
                                <div class="metric">
                                    <div class="metric-label">Rate Limit</div>
                                    <div class="metric-value" id="rateLimit">60/min</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Query Validation</div>
                                    <div class="metric-value" id="queryValidation">Active</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Health Check Latency</div>
                                    <div class="metric-value" id="healthLatency">--</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Last Backup</div>
                                    <div class="metric-value" id="lastBackup">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="refreshAIDBHealth()" class="action-btn" style="background: var(--accent-cyan); color: var(--bg-primary); border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; font-weight: 600;">
                                üîÑ Refresh Health
                            </button>
                            <button onclick="viewDetailedHealth()" class="action-btn" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">
                                üìä Detailed Status
                            </button>
                            <button onclick="viewMetrics()" class="action-btn" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">
                                üìà Prometheus Metrics
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stack Health Aggregate -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Stack Health (Aggregate)</h2>
                        </div>
                        <span class="card-badge" id="stackHealthBadge">Stack Health</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Overall Status</div>
                                <div class="metric-value" id="stackOverallStatus">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Services Checked</div>
                                <div class="metric-value" id="stackServiceCount">--</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">Service Health</div>
                            <div class="data-list" id="stackHealthList">
                                <div class="loading"><div class="spinner"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Knowledge Base -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Knowledge Base</h2>
                        </div>
                        <span class="card-badge" id="knowledgeBaseBadge">Vector DB</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Total Documents</div>
                                <div class="metric-value" id="kbTotalPoints">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Real Embeddings</div>
                                <div class="metric-value" id="kbEmbeddingsPercent">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Context Relevance</div>
                                <div class="metric-value" id="kbContextRelevance">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Quality Improvement</div>
                                <div class="metric-value" id="kbQualityImprovement">--</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">Collection Breakdown</div>
                            <div class="data-list">
                                <div class="data-item">
                                    <span style="color: var(--text-secondary);">Codebase Context</span>
                                    <span id="kbCodebaseContext" style="color: var(--accent-cyan); font-weight: 600;">--</span>
                                </div>
                                <div class="data-item">
                                    <span style="color: var(--text-secondary);">Error Solutions</span>
                                    <span id="kbErrorSolutions" style="color: var(--accent-cyan); font-weight: 600;">--</span>
                                </div>
                                <div class="data-item">
                                    <span style="color: var(--text-secondary);">Best Practices</span>
                                    <span id="kbBestPractices" style="color: var(--accent-cyan); font-weight: 600;">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Telemetry Proof -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Telemetry Proof</h2>
                        </div>
                        <span class="card-badge">Feedback Loop</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Total Events</div>
                                <div class="metric-value" id="telemetryTotal">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Local Usage Rate</div>
                                <div class="metric-value" id="telemetryLocalRate">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Tokens Saved</div>
                                <div class="metric-value" id="telemetryTokens">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Last Event</div>
                                <div class="metric-value" id="telemetryLast" style="font-size: 0.85rem;">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hybrid Coordinator Metrics -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Hybrid Coordinator Metrics</h2>
                        </div>
                        <span class="card-badge" id="hybridBadge">Coordinator</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Status</div>
                                <div class="metric-value" id="hybridStatus">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Telemetry Events</div>
                                <div class="metric-value" id="hybridEvents">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Avg Value Score</div>
                                <div class="metric-value" id="hybridAvgValue">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">High-Value Count</div>
                                <div class="metric-value" id="hybridHighValue">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Patterns Extracted</div>
                                <div class="metric-value" id="hybridPatterns">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Local Routing</div>
                                <div class="metric-value" id="hybridLocalPercent">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Cache Hit Rate</div>
                                <div class="metric-value" id="hybridCacheHit">--</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.1em;">Value Score Trend</div>
                            <div id="hybridValueScores" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Continuous Improvement -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Continuous Improvement</h2>
                        </div>
                        <span class="card-badge">Learning Loop</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Total Interactions</div>
                                <div class="metric-value" id="learningTotal">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">High-Value Interactions</div>
                                <div class="metric-value" id="learningHighValue">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Learning Rate</div>
                                <div class="metric-value" id="learningRate">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Avg Value Score</div>
                                <div class="metric-value" id="learningAvgScore">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Pattern Extractions</div>
                                <div class="metric-value" id="learningPatterns">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Fine-Tune Samples</div>
                                <div class="metric-value" id="learningFinetune">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discovery Signals -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Discovery Signals</h2>
                        </div>
                        <span class="card-badge" id="discoveryBadge">Signals</span>
                    </div>
                    <div class="collapsible-content">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">High-Value Mentions</div>
                        <div class="data-list" id="discoveryCandidates">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin: 1rem 0 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">Low-Trust Signals</div>
                        <div class="data-list" id="discoverySignals">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Local Usage Proof -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Local Usage Proof</h2>
                        </div>
                        <span class="card-badge">Local Systems</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">AIDB Status</div>
                                <div class="metric-value" id="proofAidb">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">RAG Collections</div>
                                <div class="metric-value" id="proofRag">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">LLM Model</div>
                                <div class="metric-value" id="proofLlmModel">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Embedding Model</div>
                                <div class="metric-value" id="proofEmbeddingModel">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Skills Loaded</div>
                                <div class="metric-value" id="proofSkills">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Telemetry Events</div>
                                <div class="metric-value" id="proofTelemetry">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Containers Running</div>
                                <div class="metric-value" id="proofContainers">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Runtime</div>
                                <div class="metric-value" id="proofRuntime">--</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.1em;">Proof Details</div>
                            <div id="proofDetails" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedback Pipeline Health -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Feedback Pipeline</h2>
                        </div>
                        <span class="card-badge">Telemetry Files</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">AIDB Status</div>
                                <div class="metric-value" id="feedbackAidb">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">AIDB Telemetry</div>
                                <div class="metric-value" id="feedbackAidbFile">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">AIDB Last Event</div>
                                <div class="metric-value" id="feedbackAidbLast" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Hybrid Last Event</div>
                                <div class="metric-value" id="feedbackHybridLast" style="font-size: 0.85rem;">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Network & Firewall -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Network & Firewall</h2>
                        </div>
                        <span class="card-badge">Security</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Active Connections</div>
                                <div class="metric-value" id="activeConnections">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Firewall Rules</div>
                                <div class="metric-value" id="firewallRules">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">DNS Status</div>
                                <div class="metric-value" id="dnsStatus" style="font-size: 0.8rem;">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Open Ports</div>
                                <div class="metric-value" id="openPorts">--</div>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem;">
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">LISTENING PORTS:</div>
                            <div id="portsList" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">--</div>
                        </div>

                        <div style="margin-top: 1.5rem;">
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">NETWORK DEVICES:</div>
                            <div id="networkDevices" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Monitoring -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Security Monitor</h2>
                        </div>
                        <span class="card-badge">Hardening</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="status-grid" id="securityStatus">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration & Actions -->
            <div class="dashboard-section full-width">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">System Configuration</h2>
                        </div>
                        <span class="card-badge">Adjustable</span>
                    </div>
                    <div class="collapsible-content">
                        <!-- Adjustable System Variables -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="config-item">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                                    Rate Limit (req/min)
                                </label>
                                <input type="number" id="rateLimitInput" value="60" min="10" max="1000"
                                       style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <div class="config-item">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                                    Checkpoint Interval (events)
                                </label>
                                <input type="number" id="checkpointIntervalInput" value="100" min="10" max="1000"
                                       style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <div class="config-item">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                                    Backpressure Threshold (MB)
                                </label>
                                <input type="number" id="backpressureThresholdInput" value="100" min="10" max="1000"
                                       style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <div class="config-item">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                                    Log Level
                                </label>
                                <select id="logLevelInput"
                                        style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                        </div>

                        <!-- Apply Configuration Button -->
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button onclick="applyConfiguration()"
                                    style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta)); border: none; border-radius: 4px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                Apply Configuration
                            </button>
                            <button onclick="resetConfiguration()"
                                    style="padding: 0.75rem 1.5rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.3s ease;">
                                Reset to Defaults
                            </button>
                            <div id="configStatus" style="margin-left: auto; font-size: 0.85rem; color: var(--text-muted);"></div>
                        </div>

                        <!-- Current Configuration Display -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Current Active Configuration:</div>
                            <pre id="currentConfig" style="font-size: 0.8rem; color: var(--accent-cyan); overflow-x: auto; margin: 0;">Loading...</pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Learning System Status -->
            <div class="dashboard-section full-width">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Continuous Learning Status</h2>
                        </div>
                        <span class="card-badge" id="learningBadge">Checking...</span>
                    </div>
                    <div class="collapsible-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <!-- Checkpointing Status -->
                            <div style="padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Checkpointing (P2-REL-001)</div>
                                <div id="checkpointStatus" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-cyan);">--</div>
                                <div id="checkpointDetails" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">Last checkpoint: --</div>
                            </div>

                            <!-- Backpressure Status -->
                            <div style="padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Backpressure (P2-REL-004)</div>
                                <div id="backpressureStatus" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-green);">--</div>
                                <div id="backpressureDetails" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">Unprocessed: --</div>
                            </div>

                            <!-- Deduplication Stats -->
                            <div style="padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Deduplication (P6-OPS-002)</div>
                                <div id="dedupStatus" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-magenta);">--</div>
                                <div id="dedupDetails" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">Duplicates removed: --</div>
                            </div>

                            <!-- Patterns Processed -->
                            <div style="padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Patterns Processed</div>
                                <div id="patternsStatus" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-yellow);">--</div>
                                <div id="patternsDetails" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">Total patterns: --</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Circuit Breaker Status -->
            <div class="dashboard-section full-width">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Circuit Breakers (P2-REL-002)</h2>
                        </div>
                        <span class="card-badge" id="circuitBreakerBadge">Checking...</span>
                    </div>
                    <div class="collapsible-content">
                        <div id="circuitBreakerList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Harness Operations -->
            <div class="dashboard-section full-width">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">AI Harness Operations</h2>
                        </div>
                        <span class="card-badge" id="harnessOpsBadge">Initializing...</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Acceptance Pass Rate</div>
                                <div class="metric-value" id="harnessPassRate">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Discovery Invoked</div>
                                <div class="metric-value" id="harnessDiscoveryInvoked">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Discovery Cache Hit</div>
                                <div class="metric-value" id="harnessDiscoveryCache">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Policy Status</div>
                                <div class="metric-value" id="harnessPolicyStatus">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Operational Scripts</div>
                                <div class="metric-value" id="harnessScriptsReady">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Research Candidates</div>
                                <div class="metric-value" id="harnessResearchCandidates">--</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">Harness Tooling</div>
                            <div class="data-list" id="harnessScriptList">
                                <div class="loading"><div class="spinner"></div></div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="runHarnessMaintenance('phase_plan')" class="action-btn" style="background: var(--accent-cyan); color: var(--bg-primary); border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; font-weight: 600;">Run Harness Phases</button>
                            <button onclick="runHarnessMaintenance('research_sync')" class="action-btn" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">Run Research Sync</button>
                            <button onclick="runHarnessMaintenance('catalog_sync')" class="action-btn" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">Sync Library Catalog</button>
                            <button onclick="runHarnessMaintenance('acceptance_checks')" class="action-btn" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">Run Acceptance</button>
                            <div id="harnessActionStatus" style="margin-left: auto; font-size: 0.8rem; color: var(--text-muted);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Production Hardening Progress -->
            <div class="dashboard-section full-width">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Production Hardening Progress</h2>
                        </div>
                        <span class="card-badge" id="hardeningBadge">14/16 Complete (87.5%)</span>
                    </div>
                    <div class="collapsible-content">
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.9rem; color: var(--text-secondary);">Overall Progress</span>
                                <span style="font-size: 0.9rem; font-weight: 600; color: var(--accent-cyan);">87.5%</span>
                            </div>
                            <div style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: 87.5%; background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta)); transition: width 0.5s ease;"></div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <!-- P1: Security (3/3) -->
                            <div style="padding: 1rem; background: var(--bg-secondary); border-left: 3px solid var(--status-online); border-radius: 4px;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">P1: Security ‚úÖ</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    ‚Ä¢ Dashboard Authentication<br>
                                    ‚Ä¢ Rate Limiting<br>
                                    ‚Ä¢ Input Validation
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--status-online);">3/3 Complete</div>
                            </div>

                            <!-- P2: Reliability (4/4) -->
                            <div style="padding: 1rem; background: var(--bg-secondary); border-left: 3px solid var(--status-online); border-radius: 4px;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">P2: Reliability ‚úÖ</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    ‚Ä¢ Checkpointing<br>
                                    ‚Ä¢ Circuit Breakers<br>
                                    ‚Ä¢ File Locking<br>
                                    ‚Ä¢ Backpressure
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--status-online);">4/4 Complete</div>
                            </div>

                            <!-- P3: Performance (1/3) -->
                            <div style="padding: 1rem; background: var(--bg-secondary); border-left: 3px solid var(--status-warning); border-radius: 4px;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">P3: Performance ‚è≥</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    ‚Ä¢ Query optimization<br>
                                    ‚Ä¢ Connection pooling<br>
                                    ‚Ä¢ Resource limits ‚úÖ
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--status-warning);">1/3 Complete</div>
                            </div>

                            <!-- P4: Orchestration (2/2) -->
                            <div style="padding: 1rem; background: var(--bg-secondary); border-left: 3px solid var(--status-online); border-radius: 4px;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">P4: Orchestration ‚úÖ</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    ‚Ä¢ Nested orchestration ‚úÖ<br>
                                    ‚Ä¢ Agent health checks ‚úÖ
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--status-online);">2/2 Complete</div>
                            </div>

                            <!-- P5: Monitoring (1/1) -->
                            <div style="padding: 1rem; background: var(--bg-secondary); border-left: 3px solid var(--status-online); border-radius: 4px;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">P5: Monitoring ‚úÖ</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    ‚Ä¢ Metrics aggregation ‚úÖ
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--status-online);">1/1 Complete</div>
                            </div>

                            <!-- P6: Operations (3/3) -->
                            <div style="padding: 1rem; background: var(--bg-secondary); border-left: 3px solid var(--status-online); border-radius: 4px;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">P6: Operations ‚úÖ</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    ‚Ä¢ Telemetry rotation<br>
                                    ‚Ä¢ Dataset deduplication<br>
                                    ‚Ä¢ Automated backups
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--status-online);">3/3 Complete</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Container Status -->
            <div class="dashboard-section full-width">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Container Status</h2>
                        </div>
                        <span class="card-badge" id="containerBadge">-- Containers</span>
                    </div>
                    <div class="collapsible-content">
                        <input type="text" class="search-box" id="containerSearch" placeholder="üîç Search containers..." onkeyup="filterContainers()">
                        <div id="containerList">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- AI Stack Services Control -->
            <div class="dashboard-section full-width">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">AI Stack Services</h2>
                        </div>
                        <span class="card-badge" id="servicesBadge">-- Services</span>
                    </div>
                    <div class="collapsible-content">
                        <!-- Bulk Controls -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-primary);">
                            <button class="service-btn start" onclick="startAIStack()" id="startStackBtn">
                                ‚ñ∂ Start All
                            </button>
                            <button class="service-btn stop" onclick="stopAIStack()" id="stopStackBtn">
                                ‚èπ Stop All
                            </button>
                            <button class="service-btn restart" onclick="restartAIStack()" id="restartStackBtn">
                                ‚ü≤ Restart All
                            </button>
                            <div id="stackControlStatus" style="margin-left: auto; display: flex; align-items: center; font-size: 0.85rem; color: var(--text-secondary);"></div>
                        </div>

                        <!-- Individual Services -->
                        <div id="servicesList" style="display: flex; flex-direction: column; gap: 1rem;">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Persistence & Data -->
            <div class="dashboard-section full-width">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Persistent AI Data</h2>
                        </div>
                        <span class="card-badge">Storage</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Data Root</div>
                                <div class="metric-value" id="dataRoot" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Device</div>
                                <div class="metric-value" id="dataDevice" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Filesystem</div>
                                <div class="metric-value" id="dataFilesystem" style="font-size: 0.85rem;">--</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;" id="persistenceList">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Metrics -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Database Metrics</h2>
                        </div>
                        <span class="card-badge">Data Stores</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">PostgreSQL Status</div>
                                <div class="metric-value" id="dbStatus" style="font-size: 1.1rem;">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">PostgreSQL Size</div>
                                <div class="metric-value" id="dbSize">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">PostgreSQL Connections</div>
                                <div class="metric-value" id="dbConnections">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Redis Status</div>
                                <div class="metric-value" id="redisStatus" style="font-size: 1.1rem;">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Redis Keys</div>
                                <div class="metric-value" id="redisKeys">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Redis Memory</div>
                                <div class="metric-value" id="redisMemory">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Qdrant Status</div>
                                <div class="metric-value" id="qdrantStatus" style="font-size: 1.1rem;">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Qdrant Collections</div>
                                <div class="metric-value" id="qdrantCollections">--</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">MindsDB Status</div>
                                <div class="metric-value" id="mindsdbStatus" style="font-size: 1.1rem;">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Access Links -->
            <div class="dashboard-section">
                <div class="card">
                    <div class="card-header">
                        <div class="collapsible-header" onclick="toggleCollapse(this)">
                            <span class="collapsible-arrow">‚ñº</span>
                            <h2 class="card-title">Quick Access</h2>
                        </div>
                        <span class="card-badge">Links</span>
                    </div>
                    <div class="collapsible-content">
                        <div id="quickLinks">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let dashboardData = {};
        let cpuChart = null;
        let memoryChart = null;
        let diskChart = null;
        let gpuChart = null;
        let networkChart = null;
        let cpuHistory = [];
        let memoryHistory = [];
        let diskHistory = [];
        let gpuHistory = [];
        let networkRxHistory = [];
        let networkTxHistory = [];
        let lastNetSample = null;
        const LIVE_METRICS_POLL_INTERVAL_MS = 1000;
        let serviceRegistry = {};
        let serviceRegistryInitialized = false;

        // Data directory (update this path if needed)
        const DATA_DIR = `${window.location.origin}/data`;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof Chart !== 'undefined') {
                initCharts();
            } else {
                console.warn('Chart.js unavailable; rendering dashboard without charts.');
                disableCharts();
            }

            // Load initial data
            loadData(); // Initial full load (AI stack, containers, etc.)
            loadServices(); // Load services from FastAPI backend
            updateRuntimeMode();
            detectHostMetrics();
            loadStackHealth();

            // Connect WebSocket for real-time metrics (2-second updates)
            connectMetricsWebSocket();

            // Fallback polling if WebSocket fails (1-second updates)
            setInterval(loadMetricsFromAPI, LIVE_METRICS_POLL_INTERVAL_MS);

            // Refresh full dashboard less frequently (60 seconds)
            setInterval(loadData, 60000);

            // Refresh services every 10 seconds
            setInterval(loadServices, 10000);
            setInterval(updateRuntimeMode, 30000);
            // Refresh stack health every 15 seconds
            setInterval(loadStackHealth, 15000);
        });

        // Initialize Chart.js
        function initCharts() {
            const ctx = document.getElementById('cpuChart').getContext('2d');
            cpuChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU %',
                        data: [],
                        borderColor: '#00d9ff',
                        backgroundColor: 'rgba(0, 217, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#8892a6' },
                            grid: { color: '#1e3a5f' }
                        },
                        x: {
                            ticks: { color: '#8892a6' },
                            grid: { color: '#1e3a5f' }
                        }
                    }
                }
            });

            const memCtx = document.getElementById('memoryChart').getContext('2d');
            memoryChart = new Chart(memCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memory %',
                        data: [],
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.08)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#8892a6' },
                            grid: { color: '#1e3a5f' }
                        },
                        x: {
                            ticks: { color: '#8892a6' },
                            grid: { color: '#1e3a5f' }
                        }
                    }
                }
            });

            const gpuCtx = document.getElementById('gpuChart').getContext('2d');
            gpuChart = new Chart(gpuCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'GPU %',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.12)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#8892a6' },
                            grid: { color: '#1e3a5f' }
                        },
                        x: {
                            ticks: { color: '#8892a6' },
                            grid: { color: '#1e3a5f' }
                        }
                    }
                }
            });

            const diskCtx = document.getElementById('diskChart').getContext('2d');
            diskChart = new Chart(diskCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Disk %',
                        data: [],
                        borderColor: '#ffd166',
                        backgroundColor: 'rgba(255, 209, 102, 0.08)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#8892a6' },
                            grid: { color: '#1e3a5f' }
                        },
                        x: {
                            ticks: { color: '#8892a6' },
                            grid: { color: '#1e3a5f' }
                        }
                    }
                }
            });

            const netCtx = document.getElementById('networkChart').getContext('2d');
            networkChart = new Chart(netCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Download KB/s',
                            data: [],
                            borderColor: '#8ecae6',
                            backgroundColor: 'rgba(142, 202, 230, 0.08)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Upload KB/s',
                            data: [],
                            borderColor: '#ffb703',
                            backgroundColor: 'rgba(255, 183, 3, 0.08)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#8892a6' },
                            grid: { color: '#1e3a5f' }
                        },
                        x: {
                            ticks: { color: '#8892a6' },
                            grid: { color: '#1e3a5f' }
                        }
                    }
                }
            });
        }

        function disableCharts() {
            const chartBlocks = document.querySelectorAll('.chart-container');
            chartBlocks.forEach(block => {
                block.classList.add('chart-disabled');
                const note = document.createElement('div');
                note.className = 'chart-fallback';
                note.textContent = 'Charts unavailable (Chart.js not loaded)';
                block.appendChild(note);
            });
        }

        // Load only system metrics for fast updates (graphs)
        async function loadSystemMetricsOnly() {
            try {
                const systemMetrics = await fetchSystemMetrics();
                updateSystemMetricsFromAPI(systemMetrics);
                updateNetworkMetrics(buildNetworkData(systemMetrics));
            } catch (error) {
                console.error('Error loading system metrics:', error);
            }
        }

        // Load all dashboard data
        async function loadData() {
            try {
                await loadPortRegistry();
                hideLegacySections();

                const [
                    systemMetrics,
                    aiMetrics,
                    services,
                    containers,
                    actions,
                    learningStats,
                    circuitStats,
                    aidbDetailed,
                    harnessStats,
                    keywordSignals
                ] = await Promise.all([
                    fetchSystemMetrics(),
                    fetchAIMetrics(),
                    fetchServices(),
                    fetchContainers(),
                    fetchActions(),
                    fetchLearningStats(),
                    fetchCircuitBreakers(),
                    fetchAidbDetailedHealth(),
                    fetchHarnessStats(),
                    fetchJSON('keyword-signals.json')
                ]);

                const system = normalizeSystemData(systemMetrics);
                const llm = buildLLMData(aiMetrics, containers);
                const network = buildNetworkData(systemMetrics);
                const security = buildSecurityData(aidbDetailed, systemMetrics);
                const database = buildDatabaseData(aiMetrics);
                const links = buildLinksData();
                const persistence = buildPersistenceData(services, aiMetrics);
                const feedback = buildFeedbackData(aiMetrics, learningStats);
                const config = buildConfigData(actions);
                const proof = buildProofData(aiMetrics, services, learningStats);
                const hybrid = buildHybridData(aiMetrics, learningStats);
                const learning = normalizeLearningData(learningStats);
                const tokenSavings = {
                    routing: { local_percent: Number(aiMetrics?.effectiveness?.local_query_percentage ?? 0) },
                    cache: { hit_rate: 0 }
                };
                const telemetry = {
                    summary: {
                        total_events: Number(aiMetrics?.effectiveness?.total_events_processed ?? 0),
                        local_usage_rate: Number(aiMetrics?.effectiveness?.local_query_percentage ?? 0) / 100,
                        tokens_saved: Number(aiMetrics?.effectiveness?.estimated_tokens_saved ?? 0),
                        last_event_at: aiMetrics?.timestamp || new Date().toISOString()
                    }
                };

                dashboardData = {
                    system,
                    llm,
                    network,
                    security,
                    database,
                    links,
                    persistence,
                    telemetry,
                    feedback,
                    config,
                    proof,
                    hybrid,
                    learning,
                    tokenSavings,
                    keywordSignals,
                    aiMetrics: {
                        ...(aiMetrics || {}),
                        harness: {
                            ...(aiMetrics?.harness || {}),
                            ...(harnessStats ? { stats: harnessStats } : {})
                        },
                        circuit_breakers: circuitStats || {}
                    }
                };

                updateSystemMetricsFromAPI(systemMetrics);
                updateLLMStatus(llm);
                updateAgenticReadiness(dashboardData.aiMetrics);
                updateKnowledgeBase(dashboardData.aiMetrics);
                updateNetworkMetrics(network);
                updateSecurityStatus(security);
                updateDatabaseMetrics(database);
                updateQuickLinks(links);
                updatePersistenceMetrics(persistence);
                updateTelemetryMetrics(telemetry);
                updateHybridMetrics(hybrid, tokenSavings);
                updateLearningMetrics(learning);
                updateDiscoverySignals(keywordSignals);
                updateFeedbackMetrics(feedback);
                updateConfigMetrics(config);
                updateProofMetrics(proof);
                updateHarnessOverview(dashboardData.aiMetrics);
                updateHealthScore();
                updateLastUpdate();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function fetchSystemMetrics() {
            const response = await fetch(`${FASTAPI_BASE}/api/metrics/system`, { cache: 'no-store' });
            if (!response.ok) throw new Error(`system metrics unavailable (${response.status})`);
            return response.json();
        }

        async function fetchServices() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/services`, { cache: 'no-store' });
                if (!response.ok) return [];
                return await response.json();
            } catch (_) {
                return [];
            }
        }

        async function fetchContainers() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/containers`, { cache: 'no-store' });
                if (!response.ok) return [];
                return await response.json();
            } catch (_) {
                return [];
            }
        }

        async function fetchActions() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/actions/`, { cache: 'no-store' });
                if (!response.ok) return [];
                return await response.json();
            } catch (_) {
                return [];
            }
        }

        async function fetchLearningStats() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/stats/learning`, { cache: 'no-store' });
                if (!response.ok) return {};
                return await response.json();
            } catch (_) {
                return {};
            }
        }

        async function fetchCircuitBreakers() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/stats/circuit-breakers`, { cache: 'no-store' });
                if (!response.ok) return {};
                return await response.json();
            } catch (_) {
                return {};
            }
        }

        async function fetchAidbDetailedHealth() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/aidb/health/detailed`, { cache: 'no-store' });
                if (!response.ok) return {};
                return await response.json();
            } catch (_) {
                return {};
            }
        }

        async function fetchHarnessStats() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/harness/stats`, { cache: 'no-store' });
                if (!response.ok) return null;
                return await response.json();
            } catch (_) {
                return null;
            }
        }

        function normalizeSystemData(metrics) {
            const diskPercent = Number(metrics?.disk?.percent ?? 0);
            const usedDiskGB = Number(metrics?.disk?.used ?? 0) / (1024 ** 3);
            const totalDiskGB = Number(metrics?.disk?.total ?? 0) / (1024 ** 3);
            return {
                timestamp: new Date().toISOString(),
                host_name: metrics?.hostname || 'localhost',
                cpu: {
                    usage_percent: Number(metrics?.cpu?.usage_percent ?? 0),
                    temperature: metrics?.cpu?.temperature || 'N/A',
                    model: metrics?.cpu?.model || 'Unknown',
                    arch: metrics?.cpu?.arch || 'Unknown'
                },
                gpu: metrics?.gpu || {},
                memory: {
                    percent: Number(metrics?.memory?.percent ?? 0)
                },
                disk: {
                    used: `${usedDiskGB.toFixed(1)} GB`,
                    total: `${totalDiskGB.toFixed(1)} GB`,
                    percent: `${diskPercent.toFixed(1)}%`
                },
                uptime_seconds: Number(metrics?.uptime ?? 0),
                load_average: metrics?.load_average || 'N/A'
            };
        }

        function buildLLMData(aiMetrics, containers) {
            const aiServices = aiMetrics?.services || {};
            const normalize = (status) => {
                const value = String(status || '').toLowerCase();
                if (value === 'healthy' || value === 'ok' || value === 'running') return 'online';
                if (value === 'unhealthy' || value === 'stopped' || value === 'failed') return 'offline';
                return value || 'unknown';
            };

            const mappedServices = {
                aidb: { status: normalize(aiServices?.aidb?.status), url: registryServiceUrl('aidb'), services: {} },
                hybrid_coordinator: { status: normalize(aiServices?.hybrid_coordinator?.status), url: registryServiceUrl('hybrid_coordinator') },
                qdrant: { status: normalize(aiServices?.qdrant?.status), url: registryServiceUrl('qdrant') },
                llama_cpp: {
                    status: normalize(aiServices?.llama_cpp?.status),
                    url: registryServiceUrl('llama_cpp'),
                    models: aiServices?.llama_cpp?.model ? [{ id: aiServices.llama_cpp.model }] : [],
                    cached_models: []
                },
                embeddings: {
                    status: normalize(aiServices?.embeddings?.status),
                    endpoint: registryServiceUrl('embeddings'),
                    model: aiServices?.embeddings?.model || 'unknown',
                    dimensions: aiServices?.embeddings?.dimensions || 0,
                    models: []
                },
                switchboard: { status: normalize(aiServices?.switchboard?.status), url: registryServiceUrl('switchboard') }
            };

            const containerRows = Array.isArray(containers)
                ? containers.map((svc) => ({
                    name: svc.name || svc.id || 'unknown',
                    status: svc.status || 'unknown',
                    image: 'systemd unit'
                }))
                : [];

            return { services: mappedServices, containers: containerRows };
        }

        function buildNetworkData(metrics) {
            const ports = Object.values(serviceRegistry || {})
                .map((service) => service?.port)
                .filter((port) => port !== undefined && port !== null)
                .map(String);
            const iface = metrics?.network?.interface || 'unknown';
            return {
                timestamp: new Date().toISOString(),
                connections: { active: '--' },
                firewall: { rules_count: '--' },
                dns: { status: 'managed declaratively' },
                listening_ports: ports,
                neighbors: [],
                traffic: {
                    iface,
                    rx_bytes: Number(metrics?.network?.bytes_recv ?? 0),
                    tx_bytes: Number(metrics?.network?.bytes_sent ?? 0)
                }
            };
        }

        function buildSecurityData(aidbDetailed, systemMetrics) {
            const readinessHealthy = aidbDetailed?.readiness?.status === 'healthy';
            const sec = systemMetrics?.security || {};
            const firewall = sec.firewall || {};
            const apparmor = sec.mandatory_access_control || {};
            const firewallStatus = firewall.active ? 'active' : 'inactive';
            const apparmorStatus = apparmor.apparmor_active ? 'active' : 'inactive';
            return {
                authentication: { failed_logins_1h: 0 },
                mandatory_access_control: { apparmor: { status: apparmorStatus, profiles_loaded: 'systemd' } },
                firewall: { status: firewallStatus, provider: firewall.provider || 'nftables', enabled: !!firewall.enabled },
                updates: { available: 'N/A' },
                aidb_readiness: readinessHealthy ? 'healthy' : 'degraded'
            };
        }

        function buildDatabaseData(aiMetrics) {
            const services = aiMetrics?.services || {};
            return {
                postgresql: { status: 'online', database_size: '--', active_connections: '--' },
                redis: { status: 'online', keys: '--', memory_used: '--' },
                qdrant: {
                    status: String(services?.qdrant?.status || 'unknown').toLowerCase(),
                    collections: services?.qdrant?.metrics?.collection_count ?? 0
                },
                mindsdb: { status: 'not-used' }
            };
        }

        function buildHybridData(aiMetrics, learningStats) {
            return {
                status: aiMetrics?.services?.hybrid_coordinator?.status || 'unknown',
                telemetry: {
                    events: Number(learningStats?.total_metrics_tracked ?? 0),
                    avg_value_score: 0,
                    high_value_count: 0,
                    value_scores_recent: []
                },
                learning: {
                    pattern_extractions: Number(learningStats?.total_patterns_learned ?? 0)
                }
            };
        }

        function buildLinksData() {
            const docs = [
                { title: 'Agent Guide', path: 'docs/agent-guides/00-SYSTEM-OVERVIEW.md' },
                { title: 'Quick Start', path: 'docs/QUICK_START.md' },
                { title: 'README', path: 'README.md' }
            ];
            const services = [
                { name: 'Dashboard API', url: `${FASTAPI_BASE}/docs` },
                { name: 'Prometheus', url: registryServiceUrl('prometheus') },
                { name: 'Grafana', url: registryServiceUrl('grafana') },
                { name: 'Qdrant', url: registryDashboardUrl('qdrant', '/dashboard') },
                { name: 'llama.cpp', url: registryServiceUrl('llama_cpp') },
                { name: 'Embeddings', url: registryServiceUrl('embeddings') }
            ];
            return { documentation: docs, services };
        }

        function buildPersistenceData(services, aiMetrics) {
            const running = new Set(
                (services || [])
                    .filter((svc) => svc.status === 'running')
                    .map((svc) => svc.id || svc.name)
            );
            const root = '/home/hyperd/.local/share/nixos-ai-stack';
            const paths = [
                { name: 'qdrant', path: `${root}/qdrant`, exists: running.has('qdrant') || running.has('qdrant.service'), size: 'managed' },
                { name: 'postgres', path: `${root}/postgres`, exists: running.has('postgresql') || running.has('postgresql.service'), size: 'managed' },
                { name: 'redis', path: `${root}/redis`, exists: running.has('redis-mcp') || running.has('redis-mcp.service'), size: 'managed' },
                { name: 'llama.cpp models', path: `${root}/llama-cpp-models`, exists: true, size: 'managed' },
                { name: 'telemetry', path: `${root}/telemetry`, exists: true, size: `${Number(aiMetrics?.effectiveness?.total_events_processed ?? 0)} events` }
            ];
            return {
                data_root: root,
                mount: { device: 'declarative-managed', filesystem: 'nixos' },
                paths
            };
        }

        function buildFeedbackData(aiMetrics, learningStats) {
            const sizes = learningStats?.backpressure?.file_sizes || {};
            const aidbBytes = Number(sizes['aidb-events.jsonl'] ?? 0);
            const hybridBytes = Number(sizes['hybrid-events.jsonl'] ?? 0);
            const nowTs = aiMetrics?.timestamp || new Date().toISOString();
            return {
                aidb_status: aiMetrics?.services?.aidb?.status || 'unknown',
                telemetry: {
                    exists: aidbBytes >= 0,
                    bytes: aidbBytes,
                    last_event_at: nowTs
                },
                hybrid: {
                    exists: hybridBytes >= 0,
                    bytes: hybridBytes,
                    last_event_at: nowTs
                }
            };
        }

        function buildConfigData(actions) {
            const settings = [
                { label: 'Dashboard API', value: FASTAPI_BASE, path: 'runtime', hint: 'Current API base URL used by dashboard.' },
                { label: 'AIDB Endpoint', value: registryServiceUrl('aidb'), path: 'registry', hint: 'Centralized service registry value.' },
                { label: 'Hybrid Endpoint', value: registryServiceUrl('hybrid_coordinator'), path: 'registry', hint: 'Centralized service registry value.' },
                { label: 'Qdrant Endpoint', value: registryServiceUrl('qdrant'), path: 'registry', hint: 'Centralized service registry value.' },
                { label: 'llama.cpp Endpoint', value: registryServiceUrl('llama_cpp'), path: 'registry', hint: 'Centralized service registry value.' },
                { label: 'Embeddings Endpoint', value: registryServiceUrl('embeddings'), path: 'registry', hint: 'Centralized service registry value.' }
            ];

            const filteredActions = (actions || []).filter((action) => {
                const cmd = String(action.command || '').toLowerCase();
                if (!cmd) return false;
                if (cmd.includes('podman ') || cmd.includes('kubernetes') || cmd.includes('k3s')) return false;
                if (cmd.includes('generate-dashboard-data.sh')) return false;
                if (cmd.includes('check-ai-stack-health-v2.py')) return false;
                return true;
            });

            return { settings, actions: filteredActions };
        }

        function buildProofData(aiMetrics, services, learningStats) {
            const runningCount = (services || []).filter((svc) => svc.status === 'running').length;
            const collectionCount = Number(aiMetrics?.services?.qdrant?.metrics?.collection_count ?? 0);
            const telemetryEvents = Number(aiMetrics?.effectiveness?.total_events_processed ?? 0);
            const sampleSkills = ['aidb-knowledge', 'nixos-deployment', 'health-monitoring'];
            const llmModelRaw = aiMetrics?.services?.llama_cpp?.model || '';
            const embedModelRaw = aiMetrics?.services?.embeddings?.model || '';
            const llmModel = llmModelRaw ? llmModelRaw.split('/').pop() : 'N/A';
            const embeddingModel = embedModelRaw ? embedModelRaw.split('/').pop() : 'N/A';
            return {
                aidb_status: aiMetrics?.services?.aidb?.status || 'unknown',
                rag: { collection_count: collectionCount },
                llm: { model_name: llmModel, embedding_model_name: embeddingModel },
                skills: { count: sampleSkills.length, samples: sampleSkills },
                telemetry: {
                    events: telemetryEvents,
                    last_event: {
                        event_type: 'dashboard-refresh',
                        source: 'dashboard-api',
                        llm_used: 'local-first',
                        model: aiMetrics?.services?.llama_cpp?.model || 'unknown'
                    }
                },
                orchestration: {
                    runtime: 'systemd',
                    containers_running: runningCount
                }
            };
        }

        function normalizeLearningData(learningStats) {
            return {
                interactions: {
                    total: Number(learningStats?.total_metrics_tracked ?? 0),
                    high_value: 0
                },
                patterns: {
                    extractions: Number(learningStats?.total_patterns_learned ?? 0),
                    learning_rate: Number(learningStats?.deduplication?.deduplication_rate ?? 0)
                },
                value_scoring: {
                    avg_score: 0
                },
                fine_tuning: {
                    samples: Number(learningStats?.finetuning_dataset_size ?? 0)
                }
            };
        }

        function hideLegacySections() {
            const legacyTitles = new Set([
                'System Overview (Container)',
                'Production Hardening Progress'
            ]);
            const cards = document.querySelectorAll('.card');
            cards.forEach((card) => {
                const title = card.querySelector('.card-title')?.textContent?.trim();
                if (!title || !legacyTitles.has(title)) return;
                const section = card.closest('.dashboard-section');
                if (section) section.style.display = 'none';
            });
        }

        async function fetchAIMetrics() {
            try {
                if (typeof FASTAPI_BASE !== 'undefined' && FASTAPI_BASE) {
                    const response = await fetch(`${FASTAPI_BASE}/api/ai/metrics`, { cache: 'no-store' });
                    if (response.ok) {
                        return await response.json();
                    }
                }
            } catch (_) {
                // Fall back to static JSON data path resolution below.
            }
            return fetchJSON('ai_metrics.json');
        }

        async function loadPortRegistry() {
            if (serviceRegistryInitialized) return;

            try {
                const response = await fetch(`${FASTAPI_BASE}/api/ports/registry`, { cache: 'no-store' });
                if (response.ok) {
                    const payload = await response.json();
                    serviceRegistry = payload.services || {};
                    serviceRegistryInitialized = true;
                }
            } catch (_) {
                // Keep fallback registry empty; mock data will show registry-managed placeholders.
            }
        }

        function registryServiceUrl(name) {
            const url = serviceRegistry?.[name]?.url;
            return typeof url === 'string' && url.length > 0 ? url : 'registry-managed';
        }

        function registryServicePort(name) {
            const port = serviceRegistry?.[name]?.port;
            return port !== undefined && port !== null ? String(port) : 'registry-managed';
        }

        function registryDashboardUrl(name, suffix = '') {
            const base = registryServiceUrl(name);
            if (!base.startsWith('http://') && !base.startsWith('https://')) {
                return base;
            }
            return `${base.replace(/\/+$/, '')}${suffix}`;
        }

        // Fetch JSON with fallback
        async function fetchJSON(filename) {
            const homeDir = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? '' // Will use file:// protocol or local server
                : '';

            // Try multiple paths
            const paths = [
                `/data/${filename}`,
                `${homeDir}/.local/share/nixos-system-dashboard/${filename}`,
                `./data/${filename}`,
                `./${filename}`
            ];

            for (const path of paths) {
                try {
                    const cacheBuster = `?ts=${Date.now()}`;
                    const response = await fetch(`${path}${cacheBuster}`, { cache: 'no-store' });
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (e) {
                    // Continue to next path
                }
            }

            // Return mock data if all paths fail
            return getMockData(filename);
        }

        // Mock data for demo/fallback
        function getMockData(filename) {
            const mock = {
                'system.json': {
                    timestamp: new Date().toISOString(),
                    host_name: 'nixos',
                    cpu: { usage_percent: Math.random() * 50, temperature: '45.2¬∞C', cores: 8, model: 'AMD Ryzen', arch: 'x86_64' },
                    gpu: { name: 'AMD Radeon iGPU', busy_percent: 12, vram_used_mb: 256, vram_total_mb: 512 },
                    memory: { total: 32000, used: 12000, free: 20000, percent: 37.5 },
                    disk: { total: '500GB', used: '250GB', avail: '250GB', percent: '50%' },
                    uptime_seconds: 345600,
                    load_average: '1.2, 1.5, 1.8'
                },
                'llm.json': {
                    timestamp: new Date().toISOString(),
                    services: {
                        qdrant: { status: 'online', collections: 5, collection_names: ['codebase-context', 'skills-patterns', 'error-solutions'], url: registryServiceUrl('qdrant') },
                        llama_cpp: { status: 'online', models: [{id: 'qwen2.5-coder-7b'}], cached_models: ['qwen2.5-coder-7b-instruct-q4_k_m.gguf', 'Qwen3-4B-Instruct-2507-Q4_K_M.gguf', 'deepseek-coder-6.7b-instruct.Q4_K_M.gguf'], cached_models_count: 3, url: registryServiceUrl('llama_cpp') },
                        embeddings: { status: 'online', model: 'sentence-transformers/all-MiniLM-L6-v2', models: ['sentence-transformers/all-MiniLM-L6-v2', 'BAAI/bge-small-en-v1.5'], source: 'huggingface-cache', request_total: 1280, error_total: 2, memory_mb: 512.4, endpoint: registryServiceUrl('embeddings') },
                        postgres: { status: 'online', url: registryServiceUrl('postgres') },
                        redis: { status: 'online', url: registryServiceUrl('redis') },
                        open_webui: { status: 'online', url: registryServiceUrl('open_webui') },
                        mindsdb: { status: 'offline', url: registryServiceUrl('mindsdb') },
                        aidb: { status: 'online', url: registryServiceUrl('aidb'), services: { qdrant: true, redis: true, postgres: true } }
                    },
                    containers: [
                        { name: 'local-ai-qdrant', status: 'running', image: 'qdrant/qdrant:v1.16.2' },
                        { name: 'local-ai-llama-cpp', status: 'running', image: 'ghcr.io/ggml-org/llama.cpp:server' }
                    ]
                },
                'network.json': {
                    timestamp: new Date().toISOString(),
                    connections: { active: 42 },
                    firewall: { enabled: true, rules_count: 15 },
                    interfaces: [{name: 'wlan0', address: '192.168.86.192', state: 'UP'}],
                    dns: { status: 'configured (symlink)', resolvers: ['127.0.0.53'] },
                    neighbors: [
                        { ip: '192.168.86.1', mac: 'aa:bb:cc:dd:ee:ff', state: 'REACHABLE', dev: 'wlan0' },
                        { ip: '192.168.86.50', mac: '11:22:33:44:55:66', state: 'STALE', dev: 'wlan0' }
                    ],
                    listening_ports: [
                        registryServicePort('grafana'),
                        registryServicePort('open_webui'),
                        registryServicePort('qdrant'),
                        registryServicePort('llama_cpp'),
                        registryServicePort('embeddings'),
                        registryServicePort('aidb'),
                        registryServicePort('hybrid_coordinator')
                    ]
                },
                'security.json': {
                    timestamp: new Date().toISOString(),
                    authentication: { failed_logins_1h: 0 },
                    mandatory_access_control: { apparmor: { status: 'active', profiles_loaded: 24 } },
                    firewall: { status: 'active' },
                    updates: { available: '0' }
                },
                'database.json': {
                    timestamp: new Date().toISOString(),
                    postgresql: { status: 'online', database_size: '142MB', active_connections: 3 },
                    redis: { status: 'online', keys: 120, memory_used: '64MB' },
                    qdrant: { status: 'online', collections: 5 },
                    mindsdb: { status: 'offline' }
                },
                'links.json': {
                    timestamp: new Date().toISOString(),
                    documentation: [
                        { title: 'Implementation Summary', path: 'IMPLEMENTATION-SUMMARY.md', category: 'deployment' },
                        { title: 'DNS Resolution Fix', path: 'DNS-RESOLUTION-FIX.md', category: 'networking' }
                    ],
                    services: [
                        { name: 'Open WebUI', url: registryServiceUrl('open_webui'), category: 'ai' },
                        { name: 'Qdrant Dashboard', url: registryDashboardUrl('qdrant', '/dashboard'), category: 'ai' }
                    ],
                    config_files: [
                        { title: 'NixOS Configuration', path: '/etc/nixos/configuration.nix', category: 'system' }
                    ]
                },
                'persistence.json': {
                    timestamp: new Date().toISOString(),
                    data_root: '$HOME/.local/share/nixos-ai-stack',
                    mount: { device: '/dev/nvme0n1p2', filesystem: 'btrfs', mount_point: '/' },
                    paths: [
                        { name: 'qdrant', path: '$HOME/.local/share/nixos-ai-stack/qdrant', exists: true, size: '1.2G' },
                        { name: 'llama_cpp', path: '$HOME/.local/share/nixos-ai-stack/llama-cpp-models', exists: true, size: '9.6G' },
                        { name: 'open-webui', path: '$HOME/.local/share/nixos-ai-stack/open-webui', exists: true, size: '240M' },
                        { name: 'postgres', path: '$HOME/.local/share/nixos-ai-stack/postgres', exists: true, size: '620M' },
                        { name: 'redis', path: '$HOME/.local/share/nixos-ai-stack/redis', exists: true, size: '180M' },
                        { name: 'mindsdb', path: '$HOME/.local/share/nixos-ai-stack/mindsdb', exists: false, size: '0' },
                        { name: 'huggingface-cache', path: '$HOME/.cache/huggingface', exists: true, size: '12G' }
                    ]
                },
                'telemetry.json': {
                    timestamp: new Date().toISOString(),
                    status: 'online',
                    summary: {
                        total_events: 124,
                        local_events: 110,
                        remote_events: 14,
                        tokens_saved: 52000,
                        last_event_at: new Date().toISOString(),
                        telemetry_path: '$HOME/.local/share/nixos-ai-stack/telemetry/aidb-events.jsonl',
                        enabled: true,
                        local_usage_rate: 0.887
                    }
                },
                'feedback.json': {
                    timestamp: new Date().toISOString(),
                    aidb_status: 'online',
                    telemetry: {
                        path: '$HOME/.local/share/nixos-ai-stack/telemetry/aidb-events.jsonl',
                        exists: true,
                        bytes: 128000,
                        last_event_at: new Date().toISOString()
                    },
                    hybrid: {
                        path: '$HOME/.local/share/nixos-ai-stack/telemetry/hybrid-events.jsonl',
                        exists: true,
                        bytes: 64000,
                        last_event_at: new Date().toISOString()
                    }
                },
                'config.json': {
                    timestamp: new Date().toISOString(),
                    env_file: '$HOME/.config/nixos-ai-stack/.env',
                    required_services: ['qdrant', 'llama_cpp', 'postgres', 'redis', 'open_webui', 'aidb', 'mindsdb'],
                    settings: [
                        { label: 'AI Stack Data Root', value: '$HOME/.local/share/nixos-ai-stack', path: '$HOME/.config/nixos-ai-stack/.env', hint: 'Set AI_STACK_DATA to relocate persisted services.' },
                        { label: 'AIDB Port', value: registryServicePort('aidb'), path: '$HOME/.config/nixos-ai-stack/.env', hint: 'Controls AIDB MCP server port.' },
                        { label: 'llama.cpp Port', value: registryServicePort('llama_cpp'), path: '$HOME/.config/nixos-ai-stack/.env', hint: 'Controls llama.cpp inference port.' },
                        { label: 'Qdrant Port', value: registryServicePort('qdrant'), path: '$HOME/.config/nixos-ai-stack/.env', hint: 'Controls Qdrant HTTP port.' },
                        { label: 'Dashboard Refresh (seconds)', value: '15', path: 'launch-dashboard.sh', hint: 'Set DASHBOARD_COLLECT_INTERVAL to adjust refresh cadence.' },
                        { label: 'Telemetry Stale Threshold (minutes)', value: '30', path: 'scripts/verify-local-llm-feedback.sh', hint: 'Set TELEMETRY_STALE_MINUTES to change stale warnings.' }
                    ],
                    actions: [
                        { label: 'Restart AI Stack Target', command: 'sudo systemctl restart ai-stack.target', mode: 'run', category: 'Systemd' },
                        { label: 'Show AI Stack Units', command: 'systemctl --no-pager --type=service | rg \"ai-|command-center|prometheus\"', mode: 'run', category: 'Systemd' },
                        { label: 'Reload NixOS Config', command: 'sudo nixos-rebuild switch', mode: 'run', category: 'System' }
                    ]
                },
                'proof.json': {
                    timestamp: new Date().toISOString(),
                    aidb_status: 'online',
                    rag: { qdrant_collections: ['skills-patterns', 'codebase-context'], collection_count: 2 },
                    llm: { llama_cpp_models: 1 },
                    skills: { count: 24, samples: ['nixos-deployment', 'webapp-testing'] },
                    telemetry: { path: '$HOME/.local/share/nixos-ai-stack/telemetry/aidb-events.jsonl', events: 128, last_event: { timestamp: new Date().toISOString(), event_type: 'tool_execute', source: 'aidb', llm_used: 'local', model: 'Qwen' } },
                    orchestration: { runtime: 'systemd', services_running: 11 }
                },
                'hybrid-coordinator.json': {
                    timestamp: new Date().toISOString(),
                    status: 'online',
                    health: { status: 'healthy' },
                    telemetry: {
                        path: '$HOME/.local/share/nixos-ai-stack/telemetry/hybrid-events.jsonl',
                        events: 12,
                        last_event: { timestamp: new Date().toISOString(), value_score: 0.82 },
                        avg_value_score: 0.74,
                        high_value_count: 6,
                        value_scores_recent: [0.42, 0.68, 0.73, 0.91, 0.78]
                    },
                    learning: {
                        pattern_extractions: 4,
                        finetune_dataset_path: '$HOME/.local/share/nixos-ai-stack/fine-tuning/dataset.jsonl',
                        finetune_records: 18
                    }
                },
                'learning-metrics.json': {
                    timestamp: new Date().toISOString(),
                    interactions: { total: 42, high_value: 12, last_7d: 20, last_7d_high_value: 6 },
                    patterns: { extractions: 4, learning_rate: 0.19 },
                    value_scoring: { avg_score: 0.72, threshold: 0.7 },
                    fine_tuning: { dataset_path: '$HOME/.local/share/nixos-ai-stack/fine-tuning/dataset.jsonl', samples: 18 }
                },
                'token-savings.json': {
                    timestamp: new Date().toISOString(),
                    routing: { local_percent: 65.0 },
                    cache: { hit_rate: 28.0 }
                },
                'keyword-signals.json': {
                    timestamp: new Date().toISOString(),
                    status: 'ok',
                    report_path: 'docs/development/IMPROVEMENT-DISCOVERY-REPORT-2025-12-22.md',
                    candidates: [
                        { url: 'https://github.com/qdrant/qdrant/releases', repo: 'qdrant/qdrant', score: 56.0, release: 'v1.16.3', release_url: 'https://github.com/qdrant/qdrant/releases/tag/v1.16.3', stars: 27767 },
                        { url: 'https://github.com/open-webui/open-webui/releases', repo: 'open-webui/open-webui', score: 48.0, release: 'v0.6.43', release_url: 'https://github.com/open-webui/open-webui/releases/tag/v0.6.43', stars: 118476 }
                    ],
                    signals: [
                        { url: 'https://www.reddit.com/r/LocalLLaMA/', note: 'social signal; requires corroboration' },
                        { url: 'https://news.ycombinator.com/', note: 'social signal; requires corroboration' }
                    ],
                    sources: []
                }
            };
            return mock[filename] || {};
        }

        // Update system metrics
        function updateSystemMetrics(data) {
            if (!data) return;

            if (data.host_name) {
                document.getElementById('hostname').textContent = data.host_name;
                document.getElementById('hostnameDetail').textContent = data.host_name;
            } else {
                document.getElementById('hostname').textContent = 'nixos';
                document.getElementById('hostnameDetail').textContent = 'nixos';
            }

            document.getElementById('cpuUsage').innerHTML = `${data.cpu.usage_percent.toFixed(1)}<span class="metric-unit">%</span>`;
            document.getElementById('cpuModel').textContent = data.cpu.model || '--';
            document.getElementById('cpuTemp').textContent = data.cpu.temperature;
            document.getElementById('uptime').textContent = formatUptime(data.uptime_seconds);
            document.getElementById('loadAvg').textContent = data.load_average;
            document.getElementById('cpuArch').textContent = data.cpu.arch || '--';

            const gpu = data.gpu || {};
            document.getElementById('gpuName').textContent = gpu.name || '--';
            if (gpu.busy_percent !== null && gpu.busy_percent !== undefined && gpu.busy_percent !== 'null') {
                document.getElementById('gpuBusy').textContent = `${gpu.busy_percent}%`;
            } else {
                document.getElementById('gpuBusy').textContent = '--';
            }
            if (gpu.vram_used_mb !== null && gpu.vram_total_mb !== null && gpu.vram_used_mb !== 'null' && gpu.vram_total_mb !== 'null') {
                document.getElementById('gpuVram').textContent = `${gpu.vram_used_mb} / ${gpu.vram_total_mb} MB`;
            } else {
                document.getElementById('gpuVram').textContent = '--';
            }

            document.getElementById('memoryPercent').textContent = `${data.memory.percent.toFixed(1)} %`;
            document.getElementById('memoryBar').style.width = `${data.memory.percent}%`;
            document.getElementById('memoryUsed').textContent = data.memory.used;
            document.getElementById('memoryTotal').textContent = data.memory.total;

            const diskPercent = parseFloat(data.disk.percent);
            document.getElementById('diskPercent').textContent = data.disk.percent;
            document.getElementById('diskBar').style.width = `${diskPercent}%`;
            document.getElementById('diskUsed').textContent = data.disk.used;
            document.getElementById('diskTotal').textContent = data.disk.total;

            // Update CPU chart
            if (cpuChart && memoryChart && diskChart && gpuChart) {
                cpuHistory.push(data.cpu.usage_percent);
                if (cpuHistory.length > 20) cpuHistory.shift();

                cpuChart.data.labels = cpuHistory.map(() => '');
                cpuChart.data.datasets[0].data = cpuHistory;
                cpuChart.update('none');

                memoryHistory.push(data.memory.percent);
                if (memoryHistory.length > 20) memoryHistory.shift();
                memoryChart.data.labels = memoryHistory.map(() => '');
                memoryChart.data.datasets[0].data = memoryHistory;
                memoryChart.update('none');

                diskHistory.push(parseFloat(data.disk.percent));
                if (diskHistory.length > 20) diskHistory.shift();
                diskChart.data.labels = diskHistory.map(() => '');
                diskChart.data.datasets[0].data = diskHistory;
                diskChart.update('none');
            }

            let gpuValue = 0;
            if (gpu.busy_percent !== null && gpu.busy_percent !== undefined && gpu.busy_percent !== 'null') {
                gpuValue = Number(gpu.busy_percent) || 0;
            }
            if (gpuChart) {
                gpuHistory.push(gpuValue);
                if (gpuHistory.length > 20) gpuHistory.shift();
                gpuChart.data.labels = gpuHistory.map(() => '');
                gpuChart.data.datasets[0].data = gpuHistory;
                gpuChart.update('none');
            }
        }

        // Update LLM status
        function updateLLMStatus(data) {
            if (!data || !data.services) return;

            const container = document.getElementById('llmStatus');
            container.innerHTML = '';

            const services = data.services;
            let onlineCount = 0;

            for (const [key, service] of Object.entries(services)) {
                if (!service || !service.status) {
                    continue;
                }

                if (service.status === 'online') onlineCount++;

                const item = document.createElement('div');
                item.className = `status-item ${service.status}`;
                const label = key.replace(/_/g, ' ').toUpperCase();
                item.innerHTML = `
                    <span class="status-label">${label}</span>
                    <span class="status-badge ${service.status}">
                        <span class="status-dot"></span>
                        ${service.status.toUpperCase()}
                    </span>
                `;
                container.appendChild(item);
            }

            document.getElementById('llmBadge').textContent = `${onlineCount}/${Object.keys(services).length} Online`;

            // Update container list
            updateContainerList(data.containers || []);

            const cachedContainer = document.getElementById('llamaCachedModels');
            if (cachedContainer) {
                const cached = services.llama_cpp?.cached_models || [];
                if (!cached.length) {
                    cachedContainer.innerHTML = `
                        <div class="data-item">
                            <span>Cached GGUFs</span>
                            <span class="data-meta">none</span>
                        </div>
                    `;
                } else {
                    cachedContainer.innerHTML = cached.map(name => `
                        <div class="data-item">
                            <span>${name}</span>
                            <span class="data-meta">cached</span>
                        </div>
                    `).join('');
                }
            }

            const embeddingContainer = document.getElementById('embeddingCachedModels');
            if (embeddingContainer) {
                const embeddingModels = services.embeddings?.models || [];
                if (!embeddingModels.length) {
                    embeddingContainer.innerHTML = `
                        <div class="data-item">
                            <span>Sentence-Transformers</span>
                            <span class="data-meta">none</span>
                        </div>
                    `;
                } else {
                    embeddingContainer.innerHTML = embeddingModels.map(name => `
                        <div class="data-item">
                            <span>${name}</span>
                            <span class="data-meta">cached</span>
                        </div>
                    `).join('');
                }
            }

            const usageContainer = document.getElementById('embeddingUsage');
            if (usageContainer) {
                const embeddings = services.embeddings || {};
                const status = embeddings.status || 'unknown';
                const requestTotal = embeddings.request_total ?? '--';
                const errorTotal = embeddings.error_total ?? '--';
                const memoryMb = embeddings.memory_mb !== undefined
                    ? `${embeddings.memory_mb} MB`
                    : '--';
                usageContainer.innerHTML = `
                    <div class="data-item">
                        <span>Status</span>
                        <span class="data-meta">${status}</span>
                    </div>
                    <div class="data-item">
                        <span>Requests</span>
                        <span class="data-meta">${requestTotal}</span>
                    </div>
                    <div class="data-item">
                        <span>Errors</span>
                        <span class="data-meta">${errorTotal}</span>
                    </div>
                    <div class="data-item">
                        <span>Memory</span>
                        <span class="data-meta">${memoryMb}</span>
                    </div>
                `;
            }
        }

        // Update agentic readiness metrics
        function updateAgenticReadiness(data) {
            if (!data || !data.services) return;

            const container = document.getElementById('agenticStatus');
            container.innerHTML = '';

            const aidb = data.services.aidb || { status: 'offline', services: {} };
            const qdrant = data.services.qdrant || { metrics: {} };
            const llamaCpp = data.services.llama_cpp || { status: 'unknown' };
            const embeddings = data.services.embeddings || { status: 'unknown' };
            const aidbStatus = (aidb.status || 'offline').toString().toLowerCase();
            const aidbOnline = ['online', 'ok', 'healthy'].includes(aidbStatus);
            const llamaStatus = (llamaCpp.status || 'unknown').toString().toLowerCase();
            const llamaOnline = ['ok', 'healthy'].includes(llamaStatus);
            const embeddingsStatus = (embeddings.status || 'unknown').toString().toLowerCase();
            const embeddingsOnline = ['ok', 'healthy'].includes(embeddingsStatus);

            const items = [
                {
                    label: 'AIDB MCP',
                    value: aidbStatus.toUpperCase(),
                    status: aidbOnline ? 'online' : 'offline'
                },
                {
                    label: 'Qdrant Vector DB',
                    value: `${qdrant.metrics.collection_count || 0} collections`,
                    status: (qdrant.metrics.collection_count || 0) > 0 ? 'online' : 'warning'
                },
                {
                    label: 'llama.cpp Inference',
                    value: llamaOnline ? 'ONLINE' : llamaStatus.toUpperCase(),
                    status: llamaOnline ? 'online' : 'warning'
                },
                {
                    label: 'Embeddings Service',
                    value: embeddingsOnline ? 'ONLINE' : embeddingsStatus.toUpperCase(),
                    status: embeddingsOnline ? 'online' : 'warning'
                }
            ];

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `status-item ${item.status}`;
                el.innerHTML = `
                    <span class="status-label">${item.label}</span>
                    <span class="status-badge ${item.status}">
                        <span class="status-dot"></span>
                        ${item.value}
                    </span>
                `;
                container.appendChild(el);
            });

            // Update embeddings info
            const embeddingsModel = embeddings.model || 'unknown';
            const embeddingsDims = embeddings.dimensions || 384;
            const embeddingsEndpoint = embeddings.endpoint || registryServiceUrl('embeddings');
            document.getElementById('embeddingsInfo').textContent =
                `${embeddingsModel} (${embeddingsDims}D) @ ${embeddingsEndpoint}`;
        }

        // Update knowledge base metrics
        function updateKnowledgeBase(data) {
            if (!data || !data.knowledge_base) return;

            const kb = data.knowledge_base;

            // Update main metrics
            document.getElementById('kbTotalPoints').textContent = kb.total_points || 0;
            document.getElementById('kbEmbeddingsPercent').textContent = `${kb.real_embeddings_percent || 0}%`;
            document.getElementById('kbContextRelevance').textContent = kb.rag_quality?.context_relevance || '--';
            document.getElementById('kbQualityImprovement').textContent = kb.rag_quality?.improvement_over_baseline || '--';

            // Update collection breakdown
            if (kb.collections) {
                document.getElementById('kbCodebaseContext').textContent = kb.collections.codebase_context || 0;
                document.getElementById('kbErrorSolutions').textContent = kb.collections.error_solutions || 0;
                document.getElementById('kbBestPractices').textContent = kb.collections.best_practices || 0;
            }

            // Update badge with total points
            const badge = document.getElementById('knowledgeBaseBadge');
            if (badge) {
                badge.textContent = `${kb.total_points || 0} Docs`;
            }
        }

        // Update container list
        function updateContainerList(containers) {
            const container = document.getElementById('containerList');
            container.innerHTML = '';

            document.getElementById('containerBadge').textContent = `${containers.length} Containers`;

            containers.forEach(c => {
                const item = document.createElement('div');
                item.className = 'container-item';
                item.setAttribute('data-name', c.name.toLowerCase());
                item.innerHTML = `
                    <div class="container-name">${c.name}</div>
                    <div class="container-meta">
                        <span>üì¶ ${c.image}</span>
                        <span>‚ö° ${c.status}</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // Update network metrics
        function updateNetworkMetrics(data) {
            if (!data) return;

            document.getElementById('activeConnections').textContent = data.connections.active;
            document.getElementById('firewallRules').textContent = data.firewall.rules_count;
            document.getElementById('dnsStatus').textContent = data.dns.status;
            document.getElementById('openPorts').textContent = data.listening_ports.length;
            document.getElementById('portsList').textContent = data.listening_ports.join(', ');

            const devices = data.neighbors || [];
            if (devices.length === 0) {
                document.getElementById('networkDevices').textContent = '--';
            } else {
                const sample = devices.slice(0, 10).map(d => `${d.ip || 'unknown'} (${d.mac || 'n/a'}) ${d.state || ''}`).join(', ');
                document.getElementById('networkDevices').textContent = sample;
            }

            const traffic = data.traffic || {};
            const iface = traffic.iface || '--';
            document.getElementById('netIface').textContent = iface;

            if (traffic.rx_bytes !== undefined && traffic.tx_bytes !== undefined) {
                const now = Date.parse(data.timestamp) || Date.now();
                if (lastNetSample && lastNetSample.ts) {
                    const deltaSec = Math.max((now - lastNetSample.ts) / 1000, 1);
                    const rxRate = Math.max((traffic.rx_bytes - lastNetSample.rx) / deltaSec, 0);
                    const txRate = Math.max((traffic.tx_bytes - lastNetSample.tx) / deltaSec, 0);

                    document.getElementById('netRxRate').textContent = `${(rxRate / 1024).toFixed(1)} KB/s`;
                    document.getElementById('netTxRate').textContent = `${(txRate / 1024).toFixed(1)} KB/s`;

                    if (networkChart) {
                        networkRxHistory.push(rxRate / 1024);
                        networkTxHistory.push(txRate / 1024);
                        if (networkRxHistory.length > 20) networkRxHistory.shift();
                        if (networkTxHistory.length > 20) networkTxHistory.shift();
                        networkChart.data.labels = networkRxHistory.map(() => '');
                        networkChart.data.datasets[0].data = networkRxHistory;
                        networkChart.data.datasets[1].data = networkTxHistory;
                        networkChart.update('none');
                    }
                }

                lastNetSample = { ts: now, rx: traffic.rx_bytes, tx: traffic.tx_bytes };
            }
        }

        // Update security status
        function updateSecurityStatus(data) {
            if (!data) return;

            const container = document.getElementById('securityStatus');
            container.innerHTML = '';
            const updatesAvailable = parseInt(data.updates.available, 10);
            const updatesLabel = Number.isNaN(updatesAvailable)
                ? data.updates.available
                : `${updatesAvailable} available`;
            const updatesStatus = Number.isNaN(updatesAvailable)
                ? 'warning'
                : (updatesAvailable === 0 ? 'online' : 'warning');

            const items = [
                {
                    label: 'Failed Logins (1h)',
                    value: data.authentication.failed_logins_1h,
                    status: data.authentication.failed_logins_1h === 0 ? 'online' : 'warning'
                },
                {
                    label: 'AppArmor',
                    value: `${data.mandatory_access_control.apparmor.status} (${data.mandatory_access_control.apparmor.profiles_loaded} profiles)`,
                    status: data.mandatory_access_control.apparmor.status === 'active' ? 'online' : 'warning'
                },
                {
                    label: 'Firewall',
                    value: `${data.firewall.status}${data.firewall.provider ? ` (${data.firewall.provider}, ${data.firewall.enabled ? 'enabled' : 'disabled'})` : ''}`,
                    status: data.firewall.status === 'active' ? 'online' : 'offline'
                },
                {
                    label: 'System Updates',
                    value: updatesLabel,
                    status: updatesStatus
                }
            ];

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `status-item ${item.status}`;
                el.innerHTML = `
                    <span class="status-label">${item.label}</span>
                    <span class="status-badge ${item.status}">
                        <span class="status-dot"></span>
                        ${item.value}
                    </span>
                `;
                container.appendChild(el);
            });
        }

        // Update database metrics
        function updateDatabaseMetrics(data) {
            if (!data || !data.postgresql) return;

            const pg = data.postgresql;
            document.getElementById('dbStatus').textContent = pg.status.toUpperCase();
            document.getElementById('dbSize').textContent = pg.database_size;
            document.getElementById('dbConnections').textContent = pg.active_connections;

            if (data.redis) {
                document.getElementById('redisStatus').textContent = data.redis.status.toUpperCase();
                document.getElementById('redisKeys').textContent = data.redis.keys;
                document.getElementById('redisMemory').textContent = data.redis.memory_used;
            }
            if (data.qdrant) {
                document.getElementById('qdrantStatus').textContent = data.qdrant.status.toUpperCase();
                document.getElementById('qdrantCollections').textContent = data.qdrant.collections;
            }
            if (data.mindsdb) {
                document.getElementById('mindsdbStatus').textContent = data.mindsdb.status.toUpperCase();
            }
        }

        // Update persistence metrics
        function updatePersistenceMetrics(data) {
            if (!data) return;

            document.getElementById('dataRoot').textContent = data.data_root || '--';
            document.getElementById('dataDevice').textContent = data.mount?.device || '--';
            document.getElementById('dataFilesystem').textContent = data.mount?.filesystem || '--';

            const list = document.getElementById('persistenceList');
            list.innerHTML = '';

            if (!data.paths || !data.paths.length) {
                list.textContent = 'No persistent data paths detected';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'data-list';

            data.paths.forEach(path => {
                const item = document.createElement('div');
                item.className = 'data-item';
                item.innerHTML = `
                    <div>
                        <div>${path.name}</div>
                        <div class="data-meta">${path.path}</div>
                    </div>
                    <div>${path.exists ? path.size : 'missing'}</div>
                `;
                grid.appendChild(item);
            });

            list.appendChild(grid);
        }

        // Update telemetry metrics
        function updateTelemetryMetrics(data) {
            if (!data || !data.summary) return;

            const summary = data.summary;
            document.getElementById('telemetryTotal').textContent = summary.total_events ?? '--';
            const localRate = parseFloat(summary.local_usage_rate ?? 0);
            document.getElementById('telemetryLocalRate').textContent = `${localRate.toFixed(1)}%`;
            document.getElementById('telemetryTokens').textContent = summary.tokens_saved ?? 0;
            document.getElementById('telemetryLast').textContent = formatTimestampWithStaleness(summary.last_event_at, 30);
        }

        function updateHybridMetrics(hybrid, tokenSavings) {
            if (!hybrid) return;

            const status = hybrid.status || 'offline';
            document.getElementById('hybridStatus').textContent = status.toUpperCase();
            document.getElementById('hybridBadge').textContent = status === 'online' ? 'ONLINE' : 'OFFLINE';

            const telemetry = hybrid.telemetry || {};
            document.getElementById('hybridEvents').textContent = telemetry.events ?? 0;

            const avgScore = parseFloat(telemetry.avg_value_score ?? 0);
            document.getElementById('hybridAvgValue').textContent = avgScore.toFixed(2);
            document.getElementById('hybridHighValue').textContent = telemetry.high_value_count ?? 0;

            const learning = hybrid.learning || {};
            document.getElementById('hybridPatterns').textContent = learning.pattern_extractions ?? 0;

            const routingPercent = parseFloat(tokenSavings?.routing?.local_percent ?? 0);
            document.getElementById('hybridLocalPercent').textContent = `${routingPercent.toFixed(1)}%`;
            const cacheHit = parseFloat(tokenSavings?.cache?.hit_rate ?? 0);
            document.getElementById('hybridCacheHit').textContent = `${cacheHit.toFixed(1)}%`;

            const scores = telemetry.value_scores_recent || [];
            document.getElementById('hybridValueScores').textContent = scores.length
                ? scores.map(score => score.toFixed(2)).join(' ‚Üí ')
                : '--';
        }

        function updateLearningMetrics(data) {
            if (!data) return;

            const interactions = data.interactions || {};
            const patterns = data.patterns || {};
            const scoring = data.value_scoring || {};
            const fineTuning = data.fine_tuning || {};

            document.getElementById('learningTotal').textContent = interactions.total ?? 0;
            document.getElementById('learningHighValue').textContent = interactions.high_value ?? 0;

            const learningRate = parseFloat(patterns.learning_rate ?? 0);
            document.getElementById('learningRate').textContent = learningRate.toFixed(3);

            const avgScore = parseFloat(scoring.avg_score ?? 0);
            document.getElementById('learningAvgScore').textContent = avgScore.toFixed(2);
            document.getElementById('learningPatterns').textContent = patterns.extractions ?? 0;
            document.getElementById('learningFinetune').textContent = fineTuning.samples ?? 0;
        }

        function updateHarnessOverview(aiMetrics) {
            const harness = aiMetrics?.harness || {};
            const overview = harness.overview || {};
            const scorecard = harness.scorecard || {};
            const stats = harness.stats || {};
            const acceptance = scorecard.acceptance || {};
            const maintenance = overview.maintenance || {};
            const policies = overview.policies || {};
            const discovery = scorecard.discovery || {};
            const scripts = Array.isArray(maintenance.scripts) ? maintenance.scripts : [];
            const totalRuns = Number(acceptance.total ?? stats.total_runs ?? 0);
            const passedRuns = Number(acceptance.passed ?? stats.passed ?? 0);
            const passRate = totalRuns > 0 ? (passedRuns / totalRuns) * 100 : null;
            const scriptsReady = Number.isFinite(Number(maintenance.operational_scripts)) ? Number(maintenance.operational_scripts) : null;
            const scriptsTotal = Number.isFinite(Number(maintenance.total_scripts)) ? Number(maintenance.total_scripts) : null;
            const researchRaw = maintenance.weekly_research?.candidate_count;
            const researchCandidates = Number.isFinite(Number(researchRaw)) && maintenance.weekly_research?.available !== false
                ? Number(researchRaw)
                : null;
            const discoveryInvoked = Number.isFinite(Number(discovery.invoked)) ? Number(discovery.invoked) : null;
            const discoveryCache = Number.isFinite(Number(discovery.cache_hit_rate))
                ? Number(discovery.cache_hit_rate) * 100
                : null;

            document.getElementById('harnessPassRate').textContent = passRate === null ? 'N/A' : `${passRate.toFixed(1)}%`;
            document.getElementById('harnessDiscoveryInvoked').textContent = discoveryInvoked === null ? 'N/A' : `${discoveryInvoked}`;
            document.getElementById('harnessDiscoveryCache').textContent = discoveryCache === null ? 'N/A' : `${discoveryCache.toFixed(1)}%`;
            document.getElementById('harnessScriptsReady').textContent =
                scriptsReady === null || scriptsTotal === null ? 'N/A' : `${scriptsReady}/${scriptsTotal}`;
            document.getElementById('harnessResearchCandidates').textContent = researchCandidates === null ? 'N/A' : `${researchCandidates}`;

            const toolPolicyPresent = Object.keys(policies.tool_execution_policy || {}).length > 0;
            const outboundPolicyPresent = Object.keys(policies.outbound_http_policy || {}).length > 0;
            document.getElementById('harnessPolicyStatus').textContent =
                toolPolicyPresent || outboundPolicyPresent ? 'CONFIGURED' : 'UNSET';

            const badge = document.getElementById('harnessOpsBadge');
            if (badge) {
                const healthy = passRate !== null && passRate >= 70 && totalRuns > 0;
                badge.textContent = healthy ? 'Operational' : 'Needs Attention';
                badge.style.background = healthy ? 'var(--status-online)' : 'var(--status-warning)';
                badge.style.color = healthy ? 'var(--bg-primary)' : 'var(--bg-primary)';
            }

            const list = document.getElementById('harnessScriptList');
            if (list) {
                if (!scripts.length) {
                    list.innerHTML = `<div class="data-item"><span>Harness script inventory unavailable in current API build</span><span class="data-meta">limited</span></div>`;
                } else {
                    list.innerHTML = scripts.map((script) => {
                        const ok = script.exists && script.executable;
                        const state = ok ? 'ready' : 'missing';
                        return `
                            <div class="data-item">
                                <span>${script.name}</span>
                                <span class="data-meta ${ok ? 'status-online' : 'status-offline'}">${state}</span>
                            </div>
                        `;
                    }).join('');
                }
            }
        }

        async function runHarnessMaintenance(action) {
            const statusEl = document.getElementById('harnessActionStatus');
            if (statusEl) {
                statusEl.textContent = `Running ${action}...`;
                statusEl.style.color = 'var(--status-warning)';
            }
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/harness/maintenance/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                if (response.status === 404) {
                    throw new Error('maintenance endpoint not available in current API build');
                }
                const payload = await response.json();
                if (!response.ok || !payload.success) {
                    throw new Error(payload?.stderr || payload?.detail || `HTTP ${response.status}`);
                }
                if (statusEl) {
                    statusEl.textContent = `${action}: success`;
                    statusEl.style.color = 'var(--status-online)';
                }
                await refreshDashboard();
            } catch (error) {
                if (statusEl) {
                    statusEl.textContent = `${action}: failed`;
                    statusEl.style.color = 'var(--status-error)';
                }
                console.error(`Harness maintenance action failed (${action}):`, error);
            }
        }

        function updateDiscoverySignals(data) {
            if (!data) return;

            const badge = document.getElementById('discoveryBadge');
            const candidatesEl = document.getElementById('discoveryCandidates');
            const signalsEl = document.getElementById('discoverySignals');

            const candidates = Array.isArray(data.candidates) ? data.candidates : [];
            const signals = Array.isArray(data.signals) ? data.signals : [];
            const candidateCount = data.summary?.candidate_count ?? candidates.length ?? 0;
            const signalCount = data.summary?.signal_count ?? signals.length ?? 0;

            // Show meaningful badge based on what we have
            if (candidateCount > 0) {
                badge.textContent = `${candidateCount} High-Value`;
            } else if (signalCount > 0) {
                badge.textContent = `${signalCount} Signals`;
            } else {
                badge.textContent = 'No Data';
            }

            const renderList = (container, items, emptyLabel, limit) => {
                container.innerHTML = '';
                if (!items.length) {
                    const empty = document.createElement('div');
                    empty.className = 'data-item';
                    empty.textContent = emptyLabel;
                    container.appendChild(empty);
                    return;
                }

                items.slice(0, limit).forEach((item) => {
                    const entry = document.createElement('div');
                    entry.className = 'data-item';

                    const label = document.createElement('div');
                    const link = document.createElement('a');
                    link.href = item.release_url || item.url || '#';
                    link.target = '_blank';
                    link.rel = 'noopener';
                    link.textContent = item.repo || item.url || 'Unknown source';
                    link.style.color = 'var(--text-primary)';
                    link.style.textDecoration = 'none';
                    label.appendChild(link);

                    const meta = document.createElement('div');
                    meta.className = 'data-meta';
                    if (item.score !== undefined) {
                        meta.textContent = `Score ${item.score}`;
                    } else if (item.note) {
                        meta.textContent = item.note;
                    } else {
                        meta.textContent = `Signals ${signalCount}`;
                    }

                    entry.appendChild(label);
                    entry.appendChild(meta);
                    container.appendChild(entry);
                });
            };

            renderList(candidatesEl, candidates, 'No high-value mentions yet', 6);
            renderList(signalsEl, signals, 'No low-trust signals yet', 6);
        }

        // Update feedback pipeline metrics
        function updateFeedbackMetrics(data) {
            if (!data) return;

            const aidbStatus = (data.aidb_status || 'offline').toUpperCase();
            document.getElementById('feedbackAidb').textContent = aidbStatus;

            const telemetryExists = data.telemetry?.exists ? 'OK' : 'MISSING';
            const telemetryBytes = data.telemetry?.bytes ?? 0;
            document.getElementById('feedbackAidbFile').textContent = `${telemetryExists} (${formatBytes(telemetryBytes)})`;

            document.getElementById('feedbackAidbLast').textContent = formatTimestampWithStaleness(data.telemetry?.last_event_at, 30);
            document.getElementById('feedbackHybridLast').textContent = formatTimestampWithStaleness(data.hybrid?.last_event_at, 30);
        }

        function updateProofMetrics(data) {
            if (!data) return;

            document.getElementById('proofAidb').textContent = (data.aidb_status || 'offline').toUpperCase();
            document.getElementById('proofRag').textContent = data.rag?.collection_count ?? '--';
            document.getElementById('proofLlmModel').textContent = data.llm?.model_name || 'N/A';
            document.getElementById('proofEmbeddingModel').textContent = data.llm?.embedding_model_name || 'N/A';
            document.getElementById('proofSkills').textContent = data.skills?.count ?? '--';
            document.getElementById('proofTelemetry').textContent = data.telemetry?.events ?? '--';
            document.getElementById('proofContainers').textContent = data.orchestration?.containers_running ?? '--';
            document.getElementById('proofRuntime').textContent = data.orchestration?.runtime || '--';
            const details = document.getElementById('proofDetails');
            if (details) {
                const sampleSkills = (data.skills?.samples || []).join(', ');
                const lastEvent = data.telemetry?.last_event || {};
                const eventLine = lastEvent.event_type
                    ? `last_event=${lastEvent.event_type} source=${lastEvent.source || 'n/a'} llm=${lastEvent.llm_used || 'n/a'} model=${lastEvent.model || 'n/a'}`
                    : 'last_event=--';
                details.textContent = `skills=[${sampleSkills || '--'}] | ${eventLine}`;
            }
        }

        // Update quick links
        function updateQuickLinks(data) {
            if (!data) return;

            const container = document.getElementById('quickLinks');
            container.innerHTML = '';

            const linksGrid = document.createElement('div');
            linksGrid.className = 'links-grid';

            // Documentation
            if (data.documentation) {
                const docsHeader = document.createElement('div');
                docsHeader.style.cssText = 'font-size: 0.75rem; color: var(--text-muted); margin: 1rem 0 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;';
                docsHeader.textContent = 'üìö Documentation';
                linksGrid.appendChild(docsHeader);

                data.documentation.forEach(doc => {
                    const link = createLinkItem('üìÑ', doc.title, doc.path, doc.path);
                    linksGrid.appendChild(link);
                });
            }

            // Services
            if (data.services) {
                const servicesHeader = document.createElement('div');
                servicesHeader.style.cssText = 'font-size: 0.75rem; color: var(--text-muted); margin: 1rem 0 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;';
                servicesHeader.textContent = 'üåê Services';
                linksGrid.appendChild(servicesHeader);

                data.services.forEach(service => {
                    const link = createLinkItem('üîó', service.name, service.url, service.url, true);
                    linksGrid.appendChild(link);
                });
            }

            container.appendChild(linksGrid);
        }

        // Update configuration panel
        function updateConfigMetrics(data) {
            const container = document.getElementById('configList');
            const status = document.getElementById('configActionStatus');
            if (!container) return;
            container.innerHTML = '';
            if (status) {
                status.textContent = 'Ready';
            }

            if (!data || (!data.settings && !data.actions)) {
                container.textContent = 'No configuration data available';
                return;
            }

            if (data.settings && data.settings.length) {
                const settingsHeader = document.createElement('div');
                settingsHeader.style.cssText = 'font-size: 0.75rem; color: var(--text-muted); margin: 0.5rem 0; text-transform: uppercase; letter-spacing: 0.1em;';
                settingsHeader.textContent = 'Settings';
                container.appendChild(settingsHeader);

                const settingsGrid = document.createElement('div');
                settingsGrid.className = 'data-list';

                data.settings.forEach(setting => {
                    const item = document.createElement('div');
                    item.className = 'data-item';
                    item.innerHTML = `
                        <div>
                            <div>${setting.label}</div>
                            <div class="data-meta">${setting.path || ''}</div>
                            <div class="data-meta">${setting.hint || ''}</div>
                        </div>
                        <div class="copyable" title="Click to copy">${setting.value ?? '--'}</div>
                    `;
                    settingsGrid.appendChild(item);
                });
                container.appendChild(settingsGrid);
            }

            if (data.actions && data.actions.length) {
                const actionsHeader = document.createElement('div');
                actionsHeader.style.cssText = 'font-size: 0.75rem; color: var(--text-muted); margin: 1rem 0 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;';
                actionsHeader.textContent = 'Actions';
                container.appendChild(actionsHeader);

                const byCategory = {};
                data.actions.forEach(action => {
                    const category = action.category || 'General';
                    if (!byCategory[category]) {
                        byCategory[category] = [];
                    }
                    byCategory[category].push(action);
                });

                Object.keys(byCategory).sort().forEach(category => {
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = 'font-size: 0.7rem; color: var(--text-muted); margin: 0.75rem 0 0.35rem; text-transform: uppercase; letter-spacing: 0.1em;';
                    categoryHeader.textContent = category;
                    container.appendChild(categoryHeader);

                    const actionsGrid = document.createElement('div');
                    actionsGrid.className = 'data-list';

                    byCategory[category].forEach(action => {
                        const item = document.createElement('div');
                        item.className = 'data-item';
                        const mode = action.mode || 'copy';
                        const runButton = mode === 'run'
                            ? `<button class="export-btn" style="padding: 0.25rem 0.6rem; font-size: 0.75rem;" onclick="runAction('${action.label.replace(/'/g, "\\'")}')">Run</button>`
                            : `<span style="font-size: 0.75rem; color: var(--text-muted);">copy</span>`;
                        item.innerHTML = `
                            <div>
                                <div>${action.label}</div>
                                <div class="data-meta copyable" title="Click to copy">${action.command || ''}</div>
                            </div>
                            <div>${action.command ? runButton : '--'}</div>
                        `;
                        actionsGrid.appendChild(item);
                    });
                    container.appendChild(actionsGrid);
                });
            }
        }

        async function runAction(label) {
            const status = document.getElementById('configActionStatus');
            if (status) {
                status.textContent = `Running: ${label}...`;
            }
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/actions/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ label })
                });
                const payload = await response.json();
                if (status) {
                    status.textContent = payload.message || (payload.status === 'ok' ? 'Action completed' : 'Action failed');
                }
                if (payload.output) {
                    console.log(payload.output);
                }
            } catch (error) {
                if (status) {
                    status.textContent = `Action failed: ${error.message}`;
                }
            }
        }

        function createLinkItem(icon, title, path, href, external = false) {
            const link = document.createElement('a');
            link.className = 'link-item';
            link.href = href;
            if (external) link.target = '_blank';
            link.innerHTML = `
                <span class="link-icon">${icon}</span>
                <span class="link-title">${title}</span>
                <span class="link-path">${path}</span>
            `;
            return link;
        }

        // Calculate health score
        function updateHealthScore() {
            let score = 100;
            const data = dashboardData;

            // CPU penalty (over 80%)
            if (data.system && data.system.cpu.usage_percent > 80) {
                score -= 10;
            }

            // Memory penalty (over 90%)
            if (data.system && data.system.memory.percent > 90) {
                score -= 15;
            }

            // Disk penalty (over 90%)
            if (data.system && parseFloat(data.system.disk.percent) > 90) {
                score -= 10;
            }

            // Service penalties
            if (data.llm && data.llm.services) {
                const services = data.llm.services;
                const required = data.config?.required_services || [];
                if (required.length) {
                    const offlineRequired = required.filter(name => services[name]?.status === 'offline').length;
                    score -= offlineRequired * 10;
                } else {
                    const allServices = Object.values(services);
                    const offlineServices = allServices.filter(s => s.status === 'offline' && !s.optional).length;
                    score -= offlineServices * 10;
                }
            }

            // Security penalties
            if (data.security) {
                if (data.security.firewall) {
                    const firewallStatus = String(data.security.firewall.status || '').toLowerCase();
                    if (['inactive', 'disabled', 'off', 'offline', 'failed'].includes(firewallStatus)) {
                        score -= 20;
                    }
                }
                if (data.security.authentication && data.security.authentication.failed_logins_1h > 10) score -= 10;
            }

            score = Math.max(0, Math.min(100, score));

            const healthElement = document.getElementById('healthScore');
            healthElement.textContent = `${score}%`;

            // Color based on score
            if (score >= 90) {
                healthElement.style.color = 'var(--status-online)';
            } else if (score >= 70) {
                healthElement.style.color = 'var(--status-warning)';
            } else {
                healthElement.style.color = 'var(--status-error)';
            }
        }

        // Update last update time
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        // ============================================================================
        // Service Control Functions (FastAPI Backend Integration)
        // ============================================================================

        const DEFAULT_API_PORT = 8889;
        const FASTAPI_BASE = (() => {
            const params = new URLSearchParams(window.location.search);
            const paramBase = params.get('apiBase');
            const paramPort = params.get('apiPort');
            const override = window.DASHBOARD_API_BASE || window.FASTAPI_BASE;
            if (override) {
                return override.replace(/\/+$/, '');
            }
            if (paramBase) {
                return paramBase.replace(/\/+$/, '');
            }
            // In TLS/ingress mode the API is reverse-proxied at same-origin /api.
            const browserPort = window.location.port || '';
            if (browserPort === '' || browserPort === '80' || browserPort === '443') {
                return window.location.origin.replace(/\/+$/, '');
            }
            const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
            const host = window.location.hostname;
            const port = paramPort || DEFAULT_API_PORT;
            return `${protocol}//${host}:${port}`;
        })();
        const WS_BASE = FASTAPI_BASE.replace(/^http:/, 'ws:').replace(/^https:/, 'wss:');

        async function loadServices() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/services`);
                if (!response.ok) {
                    console.error('Failed to load services:', response.status);
                    return;
                }
                const services = await response.json();
                updateServicesList(services);
            } catch (error) {
                console.error('Error loading services:', error);
                // Fallback: show message that backend is not running
                const list = document.getElementById('servicesList');
                list.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                        <p>‚ö†Ô∏è FastAPI backend not running</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                            Start backend: <code>cd dashboard/backend && uvicorn api.main:app</code>
                        </p>
                    </div>
                `;
            }
        }

        function updateServicesList(services) {
            const list = document.getElementById('servicesList');
            const badge = document.getElementById('servicesBadge');

            badge.textContent = `${services.length} Services`;

            if (services.length === 0) {
                list.innerHTML = '<p style="color: var(--text-muted);">No services found</p>';
                return;
            }

            list.innerHTML = services.map(service => `
                <div class="service-item">
                    <div class="service-info">
                        <div class="service-status-dot ${service.status}"></div>
                        <div class="service-details">
                            <div class="service-name">${service.name}</div>
                            <div class="service-type">${service.type}</div>
                        </div>
                    </div>
                    <div class="service-controls">
                        <span class="service-status-badge ${service.status}">${service.status}</span>
                        <button class="service-btn start"
                                onclick="serviceAction('${service.id}', 'start')"
                                ${service.status === 'running' ? 'disabled' : ''}>
                            ‚ñ∂ Start
                        </button>
                        <button class="service-btn stop"
                                onclick="serviceAction('${service.id}', 'stop')"
                                ${service.status === 'stopped' ? 'disabled' : ''}>
                            ‚ñ† Stop
                        </button>
                        <button class="service-btn restart"
                                onclick="serviceAction('${service.id}', 'restart')">
                            ‚Üª Restart
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function serviceAction(serviceId, action) {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/services/${serviceId}/${action}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(`Failed to ${action} service: ${error.detail || 'Unknown error'}`);
                    return;
                }

                const result = await response.json();
                console.log(`Service ${action} result:`, result);

                // Reload services list after action
                setTimeout(loadServices, 1000);

            } catch (error) {
                console.error(`Error ${action}ing service:`, error);
                alert(`Error ${action}ing service: ${error.message}`);
            }
        }

        // ============================================================================
        // WebSocket Real-Time Metrics (FastAPI Backend Integration)
        // ============================================================================

        let metricsWebSocket = null;
        let useWebSocketMetrics = true;
        let useHostMetrics = false;
        let lastNetworkSample = null;

        function connectMetricsWebSocket() {
            if (!useWebSocketMetrics) return;

            try {
                metricsWebSocket = new WebSocket(`${WS_BASE}/ws/metrics`);

                metricsWebSocket.onopen = () => {
                    console.log('üì° WebSocket connected - Real-time metrics enabled');
                    // Send ping to keep connection alive
                    setInterval(() => {
                        if (metricsWebSocket?.readyState === WebSocket.OPEN) {
                            metricsWebSocket.send('ping');
                        }
                    }, 30000);
                };

                metricsWebSocket.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);

                        if (message.type === 'pong') {
                            return; // Keep-alive response
                        }

                        if (message.type === 'metrics_update' && message.data) {
                            updateSystemMetricsFromAPI(message.data);
                        }
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                metricsWebSocket.onerror = (error) => {
                    console.warn('WebSocket error, falling back to HTTP polling:', error);
                    useWebSocketMetrics = false;
                };

                metricsWebSocket.onclose = () => {
                    console.log('WebSocket closed, attempting reconnect in 5s...');
                    setTimeout(connectMetricsWebSocket, 5000);
                };

            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                useWebSocketMetrics = false;
            }
        }

        async function loadMetricsFromAPI() {
            // Fallback: Poll metrics from API if WebSocket not available
            if (useWebSocketMetrics && metricsWebSocket?.readyState === WebSocket.OPEN) {
                return; // WebSocket is handling updates
            }

            try {
                if (useHostMetrics) {
                    await loadSystemMetricsOnly();
                    return;
                }
                const metrics = await fetch(`${FASTAPI_BASE}/api/metrics/system`).then(r => r.json());
                updateSystemMetricsFromAPI(metrics);
            } catch (error) {
                console.error('Error loading metrics from API:', error);
                // Fall back to original JSON files
                loadSystemMetricsOnly();
            }
        }

        async function detectHostMetrics() {
            // API-first mode: static dashboard JSON snapshots are deprecated.
            useHostMetrics = false;
        }

        function updateSystemMetricsFromAPI(metrics) {
            // Container metrics: update container panel
            const cCpuUsage = metrics.cpu.usage_percent;
            const cMemPercent = metrics.memory.percent;
            const cDiskPercent = metrics.disk.percent;
            const cMemUsedGB = (metrics.memory.used / (1024**3)).toFixed(2);
            const cMemTotalGB = (metrics.memory.total / (1024**3)).toFixed(2);
            const cDiskUsedGB = (metrics.disk.used / (1024**3)).toFixed(1);
            const cDiskTotalGB = (metrics.disk.total / (1024**3)).toFixed(1);

            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            const setWidth = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.style.width = value;
            };

            setText('containerCpuUsage', cCpuUsage.toFixed(1));
            setText('containerCpuModel', metrics.cpu.model || 'Unknown');
            setText('containerCpuTemp', metrics.cpu.temperature || 'N/A');
            setText('containerCpuArch', metrics.cpu.arch || 'N/A');
            setText('containerLoadAvg', metrics.load_average || 'N/A');
            setText('containerMemoryPercent', cMemPercent.toFixed(1) + ' %');
            setWidth('containerMemoryBar', cMemPercent + '%');
            setText('containerMemoryUsed', cMemUsedGB);
            setText('containerMemoryTotal', cMemTotalGB);
            setText('containerDiskPercent', cDiskPercent.toFixed(1) + ' %');
            setWidth('containerDiskBar', cDiskPercent + '%');
            setText('containerDiskUsed', cDiskUsedGB);
            setText('containerDiskTotal', cDiskTotalGB + ' GB');
            setText('containerHostname', metrics.hostname || 'N/A');
            setText('containerUptime', formatUptime(metrics.uptime));

            // Update CPU
            const cpuUsage = metrics.cpu.usage_percent;
            document.getElementById('cpuUsage').textContent = cpuUsage.toFixed(1);
            document.getElementById('cpuModel').textContent = metrics.cpu.model || 'Unknown';
            document.getElementById('cpuTemp').textContent = metrics.cpu.temperature || 'N/A';
            document.getElementById('cpuArch').textContent = metrics.cpu.arch || 'N/A';
            document.getElementById('loadAvg').textContent = metrics.load_average || 'N/A';

            // Update Memory
            const memPercent = metrics.memory.percent;
            const memUsedGB = (metrics.memory.used / (1024**3)).toFixed(2);
            const memTotalGB = (metrics.memory.total / (1024**3)).toFixed(2);
            document.getElementById('memoryPercent').textContent = memPercent.toFixed(1) + ' %';
            document.getElementById('memoryBar').style.width = memPercent + '%';
            document.getElementById('memoryUsed').textContent = memUsedGB;
            document.getElementById('memoryTotal').textContent = memTotalGB;

            // Update Disk
            const diskPercent = metrics.disk.percent;
            const diskUsedGB = (metrics.disk.used / (1024**3)).toFixed(1);
            const diskTotalGB = (metrics.disk.total / (1024**3)).toFixed(1);
            document.getElementById('diskPercent').textContent = diskPercent.toFixed(1) + ' %';
            document.getElementById('diskBar').style.width = diskPercent + '%';
            document.getElementById('diskUsed').textContent = diskUsedGB;
            document.getElementById('diskTotal').textContent = diskTotalGB + ' GB';

            // Update Network (calculate rates)
            const now = Date.now();
            if (lastNetworkSample) {
                const deltaSeconds = (now - lastNetworkSample.timestamp) / 1000;
                const rxRate = (metrics.network.bytes_recv - lastNetworkSample.bytes_recv) / deltaSeconds;
                const txRate = (metrics.network.bytes_sent - lastNetworkSample.bytes_sent) / deltaSeconds;

                document.getElementById('netRxRate').textContent = formatBytes(rxRate) + '/s';
                document.getElementById('netTxRate').textContent = formatBytes(txRate) + '/s';

                if (networkChart) {
                    const rxKB = Math.max(rxRate / 1024, 0);
                    const txKB = Math.max(txRate / 1024, 0);
                    networkRxHistory.push(rxKB);
                    networkTxHistory.push(txKB);
                    if (networkRxHistory.length > 30) networkRxHistory.shift();
                    if (networkTxHistory.length > 30) networkTxHistory.shift();
                    networkChart.data.labels = networkRxHistory.map(() => '');
                    networkChart.data.datasets[0].data = networkRxHistory;
                    networkChart.data.datasets[1].data = networkTxHistory;
                    networkChart.update('none');
                }
            }
            lastNetworkSample = {
                timestamp: now,
                bytes_recv: metrics.network.bytes_recv,
                bytes_sent: metrics.network.bytes_sent
            };
            if (metrics?.network?.interface) {
                document.getElementById('netIface').textContent = metrics.network.interface;
            }

            // Update GPU if available
            if (metrics.gpu && metrics.gpu.name !== 'N/A') {
                document.getElementById('gpuName').textContent = metrics.gpu.name;
                const gpuBusy = metrics.gpu.busy_percent !== null && metrics.gpu.busy_percent !== undefined
                    ? `${metrics.gpu.busy_percent}%`
                    : (metrics.gpu.usage || 'N/A');
                const gpuVram = metrics.gpu.vram_used_mb !== null && metrics.gpu.vram_total_mb !== null
                    ? `${metrics.gpu.vram_used_mb} / ${metrics.gpu.vram_total_mb} MB`
                    : (metrics.gpu.memory || 'N/A');
                document.getElementById('gpuBusy').textContent = gpuBusy;
                document.getElementById('gpuVram').textContent = gpuVram;
            }

            const gpuBusyPercent = Number(metrics?.gpu?.busy_percent ?? 0);
            updateChartData(gpuChart, Number.isFinite(gpuBusyPercent) ? gpuBusyPercent : 0);

            // Update System Info
            document.getElementById('uptime').textContent = formatUptime(metrics.uptime);
            document.getElementById('hostname').textContent = metrics.hostname;
            document.getElementById('hostnameDetail').textContent = metrics.hostname;

            // Update Charts
            updateChartData(cpuChart, cpuUsage);
            updateChartData(memoryChart, memPercent);
            updateChartData(diskChart, diskPercent);

            // Update health score
            updateHealthScore();
            updateLastUpdate();
        }

        async function refreshDashboard() {
            const status = document.getElementById('refreshStatus');
            if (status) {
                status.textContent = 'Refreshing...';
            }
            await loadData();
            await updateRuntimeMode();
            await loadStackHealth();
            if (status) {
                status.textContent = 'Updated';
                setTimeout(() => {
                    status.textContent = '';
                }, 2000);
            }
        }

        async function loadStackHealth() {
            const list = document.getElementById('stackHealthList');
            const overall = document.getElementById('stackOverallStatus');
            const count = document.getElementById('stackServiceCount');
            const badge = document.getElementById('stackHealthBadge');

            if (!list || !overall || !count || !badge) return;

            try {
                const response = await fetch(`${FASTAPI_BASE}/api/health/aggregate`, { cache: 'no-store' });
                if (!response.ok) throw new Error('aggregate health failed');
                const data = await response.json();

                const services = data.services || {};
                const entries = Object.entries(services);

                overall.textContent = data.overall_status || '--';
                count.textContent = String(entries.length);

                if (data.overall_status === 'healthy') {
                    badge.style.background = 'var(--status-online)';
                } else if (data.overall_status === 'degraded') {
                    badge.style.background = 'var(--status-warning)';
                } else {
                    badge.style.background = 'var(--status-error)';
                }

                list.innerHTML = entries.map(([name, info]) => {
                    const status = info?.status || 'unknown';
                    const statusClass = status === 'healthy' ? 'status-online' :
                                      status === 'degraded' ? 'status-warning' : 'status-offline';
                    return `<div class="data-item">
                        <span>${name}</span>
                        <span class="data-meta ${statusClass}">${status}</span>
                    </div>`;
                }).join('');
            } catch (err) {
                overall.textContent = '--';
                count.textContent = '--';
                list.innerHTML = '<div class="data-item"><span>Stack health</span><span class="data-meta status-offline">unavailable</span></div>';
            }
        }

        // Helper functions
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${days}d ${hours}h ${mins}m`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTimestampWithStaleness(timestamp, thresholdMinutes) {
            if (!timestamp) return '--';
            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) return timestamp;
            const diffMinutes = (Date.now() - date.getTime()) / 60000;
            if (diffMinutes > thresholdMinutes) {
                return `${timestamp} (STALE ${Math.round(diffMinutes)}m)`;
            }
            return timestamp;
        }

        async function updateRuntimeMode() {
            const modeElement = document.getElementById('runtimeMode');
            if (!modeElement) return;
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/services`, { cache: 'no-store' });
                if (!response.ok) throw new Error('services fetch failed');
                const services = await response.json();
                const hasSystemd = (services || []).some((s) => s.type === 'systemd');
                modeElement.textContent = hasSystemd ? 'systemd/local' : 'unknown';
            } catch (err) {
                modeElement.textContent = 'api offline';
            }
        }

        function updateChartData(chart, value) {
            if (!chart) return;
            const next = Number(value);
            if (!Number.isFinite(next)) return;
            const labels = chart.data.labels || [];
            const data = chart.data.datasets?.[0]?.data || [];
            labels.push('');
            data.push(next);
            if (labels.length > 20) labels.shift();
            if (data.length > 20) data.shift();
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update('none');
        }

        // Collapsible sections
        function toggleCollapse(header) {
            header.classList.toggle('collapsed');
            const content = header.closest('.card-header').nextElementSibling;
            content.classList.toggle('collapsed');
        }

        // Search containers
        function filterContainers() {
            const search = document.getElementById('containerSearch').value.toLowerCase();
            const containers = document.querySelectorAll('.container-item');

            containers.forEach(container => {
                const name = container.getAttribute('data-name');
                container.style.display = name.includes(search) ? 'block' : 'none';
            });
        }

        // Copy to clipboard
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('copyable')) {
                const text = e.target.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    const original = e.target.textContent;
                    e.target.textContent = '‚úì Copied!';
                    setTimeout(() => {
                        e.target.textContent = original;
                    }, 1000);
                });
            }
        });

        // Export data for AI agents
        function exportData() {
            const dataStr = JSON.stringify(dashboardData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `system-dashboard-${new Date().toISOString()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // AI Stack Bulk Controls
        async function startAIStack() {
            const statusEl = document.getElementById('stackControlStatus');
            const startBtn = document.getElementById('startStackBtn');

            statusEl.textContent = 'Starting AI stack...';
            statusEl.style.color = 'var(--status-warning)';
            startBtn.disabled = true;

            try {
                const response = await fetch(`${FASTAPI_BASE}/api/containers/ai-stack/start`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    statusEl.textContent = '‚úì ' + result.message;
                    statusEl.style.color = 'var(--status-online)';

                    // Refresh services list after a delay
                    setTimeout(() => {
                        loadServices();
                        statusEl.textContent = '';
                    }, 3000);
                } else {
                    statusEl.textContent = '‚úó ' + result.message;
                    statusEl.style.color = 'var(--status-error)';
                }
            } catch (error) {
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = 'var(--status-error)';
            } finally {
                startBtn.disabled = false;
            }
        }

        async function stopAIStack() {
            const statusEl = document.getElementById('stackControlStatus');
            const stopBtn = document.getElementById('stopStackBtn');

            statusEl.textContent = 'Stopping AI stack...';
            statusEl.style.color = 'var(--status-warning)';
            stopBtn.disabled = true;

            try {
                const response = await fetch(`${FASTAPI_BASE}/api/containers/ai-stack/stop`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    statusEl.textContent = '‚úì ' + result.message;
                    statusEl.style.color = 'var(--status-online)';

                    // Refresh services list after a delay
                    setTimeout(() => {
                        loadServices();
                        statusEl.textContent = '';
                    }, 3000);
                } else {
                    statusEl.textContent = '‚úó ' + result.message;
                    statusEl.style.color = 'var(--status-error)';
                }
            } catch (error) {
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = 'var(--status-error)';
            } finally {
                stopBtn.disabled = false;
            }
        }

        async function restartAIStack() {
            const statusEl = document.getElementById('stackControlStatus');
            const restartBtn = document.getElementById('restartStackBtn');

            statusEl.textContent = 'Restarting AI stack...';
            statusEl.style.color = 'var(--status-warning)';
            restartBtn.disabled = true;

            try {
                const response = await fetch(`${FASTAPI_BASE}/api/containers/ai-stack/restart`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    statusEl.textContent = '‚úì ' + result.message;
                    statusEl.style.color = 'var(--status-online)';

                    // Refresh services list after a delay
                    setTimeout(() => {
                        loadServices();
                        statusEl.textContent = '';
                    }, 3000);
                } else {
                    statusEl.textContent = '‚úó ' + result.message;
                    statusEl.style.color = 'var(--status-error)';
                }
            } catch (error) {
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = 'var(--status-error)';
            } finally {
                restartBtn.disabled = false;
            }
        }

        // AIDB Health Check Functions (P1/P2 Features)
        async function refreshAIDBHealth() {
            try {
                // Fetch all health endpoints via dashboard API
                const baseUrl = `${FASTAPI_BASE}/api/aidb`;
                const [liveness, readiness, startup, detailed] = await Promise.all([
                    fetch(`${baseUrl}/health/live`).then(r => r.json()).catch(() => null),
                    fetch(`${baseUrl}/health/ready`).then(r => r.json()).catch(() => null),
                    fetch(`${baseUrl}/health/startup`).then(r => r.json()).catch(() => null),
                    fetch(`${baseUrl}/health/detailed`).then(r => r.json()).catch(() => null)
                ]);

                // Update health probe badges
                updateHealthBadge('livenessProbe', liveness);
                updateHealthBadge('readinessProbe', readiness);
                updateHealthBadge('startupProbe', startup);

                // Update dependency health
                if (detailed && detailed.dependencies) {
                    updateDependencyHealth(detailed.dependencies);
                }

                // Update metrics
                if (detailed && detailed.metrics) {
                    updateHealthMetrics(detailed.metrics);
                }

                // Update overall badge
                const overallHealthy = liveness?.status === 'healthy' &&
                                      readiness?.status === 'healthy';
                const badge = document.getElementById('aidbHealthBadge');
                if (badge) {
                    badge.textContent = overallHealthy ? '‚úì Healthy' : '‚ö† Degraded';
                    badge.style.background = overallHealthy ? 'var(--status-online)' : 'var(--status-warning)';
                }

            } catch (error) {
                console.error('Error refreshing AIDB health:', error);
                // Show error state
                ['livenessProbe', 'readinessProbe', 'startupProbe'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = 'Error';
                        el.className = 'status-badge status-offline';
                    }
                });
            }
        }

        function updateHealthBadge(elementId, healthData) {
            const el = document.getElementById(elementId);
            if (!el) return;

            if (!healthData) {
                el.textContent = 'Offline';
                el.className = 'status-badge status-offline';
                return;
            }

            const status = healthData.status;
            el.textContent = status.charAt(0).toUpperCase() + status.slice(1);

            if (status === 'healthy') {
                el.className = 'status-badge status-online';
            } else if (status === 'degraded') {
                el.className = 'status-badge status-warning';
            } else {
                el.className = 'status-badge status-offline';
            }
        }

        function updateDependencyHealth(dependencies) {
            const container = document.getElementById('dependencyHealth');
            if (!container) return;

            if (!dependencies || dependencies.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.8rem;">No dependency checks available</div>';
                return;
            }

            let html = '';
            dependencies.forEach(dep => {
                const statusClass = dep.status === 'healthy' ? 'status-online' :
                                   dep.status === 'degraded' ? 'status-warning' : 'status-offline';
                const statusIcon = dep.status === 'healthy' ? '‚úì' :
                                  dep.status === 'degraded' ? '‚ö†' : '‚úó';

                html += `
                    <div class="data-item">
                        <div class="data-label">${dep.name}</div>
                        <div class="data-value">
                            <span class="status-badge ${statusClass}">${statusIcon} ${dep.status}</span>
                            ${dep.latency_ms ? `<span style="font-size: 0.75rem; color: var(--text-muted); margin-left: 0.5rem;">${dep.latency_ms.toFixed(1)}ms</span>` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateHealthMetrics(metrics) {
            // Update health check latency
            const latencyEl = document.getElementById('healthLatency');
            if (latencyEl && metrics.health_check_latency_ms) {
                latencyEl.textContent = metrics.health_check_latency_ms.toFixed(1) + 'ms';
            }

            // Try to get last backup time from filesystem (would need backend support)
            // For now, just show a placeholder
            const backupEl = document.getElementById('lastBackup');
            if (backupEl) {
                backupEl.textContent = 'Check logs';
            }
        }

        function viewDetailedHealth() {
            window.open(`${FASTAPI_BASE}/api/aidb/health/detailed`, '_blank');
        }

        function viewMetrics() {
            window.open(`${FASTAPI_BASE}/api/aidb/metrics`, '_blank');
        }

        // Auto-refresh AIDB health every 30 seconds
        setInterval(refreshAIDBHealth, 30000);

        // ====================================================================
        // System Configuration Management
        // ====================================================================

        // Configuration object
        const systemConfig = {
            rate_limit: 60,
            checkpoint_interval: 100,
            backpressure_threshold_mb: 100,
            log_level: 'INFO'
        };

        // Load configuration from backend API
        async function loadConfiguration() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/config`);
                if (response.ok) {
                    const config = await response.json();
                    Object.assign(systemConfig, config);
                }
            } catch (error) {
                console.error('Failed to load configuration:', error);
                // Fall back to localStorage if API fails
                const saved = localStorage.getItem('systemConfig');
                if (saved) {
                    Object.assign(systemConfig, JSON.parse(saved));
                }
            }
            updateConfigurationDisplay();
            updateConfigurationInputs();
        }

        // Update display of current configuration
        function updateConfigurationDisplay() {
            const display = document.getElementById('currentConfig');
            if (display) {
                display.textContent = JSON.stringify(systemConfig, null, 2);
            }
        }

        // Update input values to match current config
        function updateConfigurationInputs() {
            document.getElementById('rateLimitInput').value = systemConfig.rate_limit;
            document.getElementById('checkpointIntervalInput').value = systemConfig.checkpoint_interval;
            document.getElementById('backpressureThresholdInput').value = systemConfig.backpressure_threshold_mb;
            document.getElementById('logLevelInput').value = systemConfig.log_level;
        }

        // Apply configuration changes
        async function applyConfiguration() {
            // Get values from inputs
            systemConfig.rate_limit = parseInt(document.getElementById('rateLimitInput').value);
            systemConfig.checkpoint_interval = parseInt(document.getElementById('checkpointIntervalInput').value);
            systemConfig.backpressure_threshold_mb = parseInt(document.getElementById('backpressureThresholdInput').value);
            systemConfig.log_level = document.getElementById('logLevelInput').value;

            // Update display
            updateConfigurationDisplay();

            // Show status
            const status = document.getElementById('configStatus');
            status.textContent = '‚è≥ Saving configuration...';
            status.style.color = 'var(--status-warning)';

            try {
                // Send to backend API
                const response = await fetch(`${FASTAPI_BASE}/api/config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(systemConfig)
                });

                if (response.ok) {
                    const result = await response.json();
                    status.textContent = `‚úì Configuration saved. Restarted: ${result.restarted.join(', ')}`;
                    status.style.color = 'var(--status-online)';

                    // Also save to localStorage as backup
                    localStorage.setItem('systemConfig', JSON.stringify(systemConfig));

                    setTimeout(() => {
                        status.textContent = '';
                    }, 5000);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Failed to save configuration:', error);
                status.textContent = '‚úó Failed to save configuration';
                status.style.color = 'var(--status-error)';

                // Fall back to localStorage
                localStorage.setItem('systemConfig', JSON.stringify(systemConfig));

                setTimeout(() => {
                    status.textContent = 'Saved locally only - services not restarted';
                    status.style.color = 'var(--text-muted)';
                }, 2000);
            }
        }

        // Reset to defaults
        function resetConfiguration() {
            systemConfig.rate_limit = 60;
            systemConfig.checkpoint_interval = 100;
            systemConfig.backpressure_threshold_mb = 100;
            systemConfig.log_level = 'INFO';

            localStorage.removeItem('systemConfig');
            updateConfigurationInputs();
            updateConfigurationDisplay();

            const status = document.getElementById('configStatus');
            status.textContent = '‚úì Reset to defaults';
            status.style.color = 'var(--status-online)';

            setTimeout(() => {
                status.textContent = '';
            }, 2000);
        }

        // ====================================================================
        // Real-Time Monitoring Functions (Phase 3)
        // ====================================================================

        // Fetch and display learning stats
        async function refreshLearningStats() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/stats/learning`);
                if (response.ok) {
                    const stats = await response.json();

                    // Update checkpointing
                    const checkpoints = stats.checkpoints || {};
                    document.getElementById('checkpointStatus').textContent =
                        checkpoints.total ? `${checkpoints.total} checkpoints` : 'Active';
                    document.getElementById('checkpointDetails').textContent =
                        checkpoints.last_checkpoint ? `Last: ${checkpoints.last_checkpoint}` : 'No checkpoints yet';

                    // Update backpressure
                    const backpressure = stats.backpressure || {};
                    const unprocessedMB = backpressure.unprocessed_mb || 0;
                    const isPaused = backpressure.paused || false;
                    document.getElementById('backpressureStatus').textContent =
                        isPaused ? 'PAUSED' : `${unprocessedMB.toFixed(1)} MB`;
                    document.getElementById('backpressureStatus').style.color =
                        isPaused ? 'var(--status-error)' : 'var(--accent-green)';
                    document.getElementById('backpressureDetails').textContent =
                        `Threshold: ${stats.backpressure_threshold_mb || 100} MB`;

                    // Update deduplication
                    const dedup = stats.deduplication || {};
                    const dupRate = dedup.total_patterns > 0
                        ? ((dedup.duplicates_found / dedup.total_patterns) * 100).toFixed(1)
                        : 0;
                    document.getElementById('dedupStatus').textContent = `${dupRate}% duplicates`;
                    document.getElementById('dedupDetails').textContent =
                        `Removed: ${dedup.duplicates_found || 0} / ${dedup.total_patterns || 0}`;

                    // Update patterns
                    document.getElementById('patternsStatus').textContent =
                        `${dedup.unique_patterns || 0} unique`;
                    document.getElementById('patternsDetails').textContent =
                        `Total processed: ${dedup.total_patterns || 0}`;

                    // Update badge
                    document.getElementById('learningBadge').textContent = 'Active';
                    document.getElementById('learningBadge').style.background = 'var(--status-online)';
                } else {
                    throw new Error('API unavailable');
                }
            } catch (error) {
                console.error('Failed to fetch learning stats:', error);
                document.getElementById('learningBadge').textContent = 'Offline';
                document.getElementById('learningBadge').style.background = 'var(--status-error)';
            }
        }

        // Fetch and display circuit breaker stats
        async function refreshCircuitBreakers() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/stats/circuit-breakers`);
                if (response.ok) {
                    const breakers = await response.json();
                    const container = document.getElementById('circuitBreakerList');

                    if (Object.keys(breakers).length === 0) {
                        container.innerHTML = '<div style="padding: 1rem; color: var(--text-muted);">No circuit breakers registered</div>';
                        document.getElementById('circuitBreakerBadge').textContent = 'None';
                        return;
                    }

                    let openCount = 0;
                    let html = '';

                    for (const [name, state] of Object.entries(breakers)) {
                        const stateColor = state === 'CLOSED' ? 'var(--status-online)' :
                                          state === 'OPEN' ? 'var(--status-error)' :
                                          'var(--status-warning)';
                        if (state === 'OPEN') openCount++;

                        html += `
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 6px;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">${name}</div>
                                <div style="font-size: 0.85rem; color: ${stateColor}; font-weight: 600;">${state}</div>
                            </div>
                        `;
                    }

                    container.innerHTML = html;

                    // Update badge
                    const totalBreakers = Object.keys(breakers).length;
                    document.getElementById('circuitBreakerBadge').textContent =
                        openCount > 0 ? `${openCount} Open` : `${totalBreakers} Healthy`;
                    document.getElementById('circuitBreakerBadge').style.background =
                        openCount > 0 ? 'var(--status-error)' : 'var(--status-online)';
                } else {
                    throw new Error('API unavailable');
                }
            } catch (error) {
                console.error('Failed to fetch circuit breaker stats:', error);
                document.getElementById('circuitBreakerBadge').textContent = 'Offline';
                document.getElementById('circuitBreakerBadge').style.background = 'var(--status-error)';
            }
        }

        // Load configuration from API (updated to use backend)
        async function loadConfiguration() {
            try {
                const response = await fetch(`${FASTAPI_BASE}/api/config`);
                if (response.ok) {
                    const config = await response.json();
                    Object.assign(systemConfig, config);
                    updateConfigurationDisplay();
                    updateConfigurationInputs();
                    return;
                }
            } catch (error) {
                console.error('Failed to load config from API:', error);
            }

            // Fallback to localStorage
            const saved = localStorage.getItem('systemConfig');
            if (saved) {
                Object.assign(systemConfig, JSON.parse(saved));
            }
            updateConfigurationDisplay();
            updateConfigurationInputs();
        }

        // Auto-refresh all monitoring data
        function startAutoRefresh() {
            // Refresh learning stats every 30 seconds
            setInterval(refreshLearningStats, 30000);

            // Refresh circuit breakers every 30 seconds
            setInterval(refreshCircuitBreakers, 30000);

            // Initial load after 3 seconds
            setTimeout(() => {
                refreshLearningStats();
                refreshCircuitBreakers();
            }, 3000);
        }

        // Initial load when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Delay initial health check by 2 seconds to let other services load first
            setTimeout(refreshAIDBHealth, 2000);

            // Load configuration
            loadConfiguration();

            // Start auto-refresh for monitoring data
            startAutoRefresh();
        });
    </script>
</body>
</html>
