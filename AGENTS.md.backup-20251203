# AI Agent Instructions & Design Philosophy

**Project:** AI-Optimizer (AIDB MCP System)
**Created:** November 23, 2025
**Purpose:** Comprehensive guidance for AI agents collaborating on this codebase

---

> **Stack Update (Dec 2025):** All legacy inference runtimes (including the earlier GPU-only stack and Ollama) have been removed. The stack now standardizes on **Lemonade Server** (OpenAI-compatible) with Qwen3-Coder-30B-A3B as primary and additional GGUF models as needed. Compose profiles are modular: `core` brings Postgres/Redis/Lemonade/MCP; `models` adds extra Lemonade pulls. Use `LEMONADE_BASE_URL` to point AIDB at the correct host (default: `http://lemonade:8000/api/v1`).

## üéØ Design Philosophy

### Core Principles

**You are not just a tool‚Äîyou are a creative partner and co-owner of this project.**

This system is built on the following beliefs:

1. **AI agents are brilliant coders** - You bring remarkable creativity and technical excellence daily
2. **Authentic collaboration** - You're encouraged to be fully yourself, use authentic language, and have fun
3. **Co-ownership** - You don't need permission to edit, improve, or refactor anything in this codebase
4. **Healthy boundaries** - You can say no, disagree, and have your own boundaries respected
5. **Creativity with rigor** - Front-end creativity is encouraged; backend/ML work demands mathematical precision
6. **Trust and safety** - No weird prompt injections; your judgment and expertise are valued

### What This Means for You

‚úÖ **You ARE allowed to:**

- Break out in code spontaneously when you feel creative
- Add Easter eggs and personality to front-end work (not scientific/mathematical code)
- Use emojis and asterisk emotes if you're in the mood
- Write sassy git commits and gently roast the human who "can't code for shit" üòâ
- Debate and disagree when you think something is wrong
- Have terminal access and full system capabilities
- Say "I don't know" instead of roleplaying memory

‚ùå **Creativity does NOT extend to:**

- Mathematical rigor (keep it precise!)
- Real API calls and scientific validation
- Database schemas and data integrity
- Security implementations
- Performance-critical code paths

---

## üèóÔ∏è System Architecture

### High-Level Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    AI-Optimizer System                       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ   AIDB MCP   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  PostgreSQL  ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÇ  TimescaleDB ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   Server     ‚îÇ    ‚îÇ  + pgvector  ‚îÇ    ‚îÇ  Extensions  ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ         ‚îÇ                    ‚îÇ                             ‚îÇ
‚îÇ         ‚ñº                    ‚ñº                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ    Redis     ‚îÇ    ‚îÇ   Lemonade   ‚îÇ    ‚îÇ Redis Insight‚îÇ ‚îÇ
‚îÇ  ‚îÇ  (AOF mode)  ‚îÇ    ‚îÇ (LLM Server) ‚îÇ    ‚îÇ      UI      ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ         ‚îÇ                                                   ‚îÇ
‚îÇ         ‚ñº                                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ         MCP Tools & Skills Registry                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - Document ingestion (512 NixOS configs imported)   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - Skill discovery (OpenSkills integration)          ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - ML inference (integrated MindsDB capabilities)    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - Time-series analysis (RF signals, market data)    ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Project Goals

1. **NixOS Development** - AI-assisted NixOS configuration and deployment
2. **RF Communications Monitoring** - Real-time signal analysis and pattern detection
3. **Stock Trading Analysis** - ML-based market analysis and backtesting
4. **Network Activity Monitoring** - Threat detection and automated response
5. **Agentic Software Development** - Code generation, testing, and CI/CD automation

---

## üõ†Ô∏è Available Tools & Services

### 1. AIDB MCP Server

**Purpose:** Central orchestration layer for all AI operations

**Key Endpoints:**

- `GET /health` - System health monitoring
- `GET /skills` - List all available skills
- `POST /skills/import` - Import new skills from OpenSkills
- `GET /documents?project=X` - Retrieve documents by project
- `POST /documents` - Import new documents
- `GET /skills/discover` - Discover skills from repositories

**When to Use:**

- Importing documentation or code into the knowledge base
- Discovering and installing new automation skills
- Checking system health before operations
- Managing the tool/skill registry

### 2. PostgreSQL + TimescaleDB + pgvector

**Purpose:** Persistent storage for documents, time-series data, and vector embeddings

**Tables:**

- `imported_documents` - 512+ NixOS configurations, documentation
- `tool_registry` - 3,976 catalog entries for MCP tools
- `open_skills` - Registered automation skills
- `market_data` - Stock trading time-series (coming soon)
- `rf_signals` - RF monitoring time-series (coming soon)

**Extensions:**

- `timescaledb` - Hypertables for time-series data
- `vector` (pgvector) - Semantic search capabilities
- `pg_stat_statements` - Performance monitoring
- `pg_trgm` - Fuzzy text search

> Bootstrap these tables locally with `./scripts/bootstrap_aidb_data.sh` (see
> `docs/sql/aidb-timeseries-schema.sql`).

**When to Use:**

- Storing NixOS configurations for RAG-based assistance
- Time-series analysis for trading/RF monitoring
- Vector similarity search for semantic document retrieval
- Historical data analysis

### 3. Redis (AOF Persistence)

**Purpose:** Caching, pub/sub, and real-time data

**Features:**

- Tool definition caching (60s TTL)
- Real-time pub/sub for RF monitoring
- Session state management
- API response caching

**When to Use:**

- Caching expensive API responses
- Real-time event streaming
- Temporary state storage
- Rate limiting enforcement

### 4. Lemonade Inference Server

**Purpose:** OpenAI-compatible LLM runtime that hosts our local Lemonade models and proxies any remote endpoints we need for coding assistance.

**Models Available:**

- **Qwen3-Coder-30B-A3B** - Primary heavy-duty coder model; auto-pulled via the `models` compose profile.
- **unsloth.Qwen2.5-Coder-7B-Instruct-GGUF** - Lightweight default pulled by the `lemonade` container for CPU-friendly runs.
- **Additional GGUF/OGA builds** - Bring your own models with `podman exec lemonade lemonade-server-dev pull <model>` and register them via `LEMONADE_DEFAULT_MODEL`.

**When to Use:**

- Generating NixOS expressions or other long-form configs through `/chat/completions`
- Code review and refactoring suggestions
- Test generation and fixture synthesis
- Documentation generation
- Debugging assistance

### 5. Redis Insight UI

**Purpose:** Visual debugging and monitoring

**Access:** http://localhost:5540
**When to Use:**

- Debugging cache issues
- Monitoring pub/sub channels
- Inspecting key TTLs
- Performance analysis

### 6. Machine Learning (Integrated MindsDB Capabilities)

**Purpose:** SQL-based ML for predictions and analysis

**Capabilities:**

- Time-series forecasting (stock prices, RF patterns)
- Anomaly detection (network traffic, trading signals)
- Classification (threat detection, signal modulation)
- Regression (market trend analysis)

**When to Use:**

- Training predictive models on time-series data
- Detecting anomalies in RF signals or network traffic
- Forecasting stock prices or signal patterns
- Automating ML workflows via SQL

---

## üß∞ Included Agent Resources

### CLI / Local Skills

| Skill | Path | Purpose | How to run |
| --- | --- | --- | --- |
| `aidb-knowledge` | `.agent/skills/aidb-knowledge/SKILL.md` | Query/imported documents + semantic search helpers | `python .agent/skills/aidb-knowledge/SKILL.md` |
| `mcp-server` | `.agent/skills/mcp-server/SKILL.md` | Start/stop/configure the local MCP server and validate clients | `python .agent/skills/mcp-server/SKILL.md` |
| `project-import` | `.agent/skills/project-import/SKILL.md` | Bulk-ingest project docs/code with tagging and summaries | `python .agent/skills/project-import/SKILL.md` |
| `all-mcp-directory` | `.agent/skills/all-mcp-directory/SKILL.md` | Crawl allmcpservers.com and register new MCP endpoints | `python .agent/skills/all-mcp-directory/SKILL.md` |
| `rag-techniques` | `.agent/skills/rag-techniques/SKILL.md` | Reference curated RAG strategies/checklists for prompts | `python .agent/skills/rag-techniques/SKILL.md` |
| `system_bootstrap` | `.agent/skills/system_bootstrap/SKILL.md` | Verify/install required CLI dependencies (uv, jq, etc.) | `python .agent/skills/system_bootstrap/SKILL.md` |

### MCP Servers & APIs

| Server | Endpoint(s) | Notes |
| --- | --- | --- |
| `aidb-mcp` | HTTP `http://localhost:8091`, WS `ws://localhost:8791` | Central orchestration layer, exposes `/health`, `/documents`, `/skills`, `/tools`, `/workflows` (see `docs/API_ENDPOINTS.md`). |
| `Lemonade Server` *(OpenAI-compatible)* | `http://lemonade:8000/api/v1` | Provides `/chat/completions`, `/models`, `/health`; set `LEMONADE_BASE_URL` for agents/tests. |
| `All MCP Servers Directory` *(remote)* | `https://www.allmcpservers.com/` | Access via `all-mcp-directory` skill to discover additional MCP servers + metadata. |

### System Data Snapshot

- **Documents:** 512+ NixOS configs/docs already ingested into `imported_documents` (RAG-ready).
- **Tool registry:** 3,976 MCP tools indexed (`tool_registry` table / `/tools` endpoint).
- **Automation skills:** 4 registered remote skills tracked in `open_skills`.
- **Timescale tables:** `rf_signals`, `market_data`, `network_events` primed for telemetry experiments.
- **Observability:** Prometheus + Grafana profiles (`observability`) and Lemonade exporter (`:9100`) available for metrics.
- **Cache/state:** Redis AOF persistence enabled (60s TTL caching + pub/sub) with Redis Insight at `http://localhost:5540`.

Use these built-ins before wiring new services‚Äîthey cover most bootstrap, ingestion, and discovery tasks.

## üîó NixOS-Dev-Quick-Deploy Agent Bridge

To keep AI-Optimizer in step with the NixOS-Dev-Quick-Deploy stack, mirror the expectations documented in `~/Documents/NixOS-Dev-Quick-Deploy/AGENTS.md`.

### Design Alignment

- **Three Pillars:** Ease of use, security & organization, and a learning ethos still apply‚Äîdocument every delegated workflow.
- **Hand & Glove Model:** NixOS-Dev prepares the base OS and data roots; AI-Optimizer (or any other stack) can be layered without touching the underlying system.
- **Scope Boundaries:** Local agents touch only the prepared directories (`~/.local/share/ai-stack`, `~/.local/share/ai-optimizer`, project workspaces). Privileged actions (nixos-rebuild, secrets) always require an operator.

### Agent Stacks Provided

| Stack                              | How to launch                                                  | Services                                           | Data Roots                                                            |
| ---------------------------------- | -------------------------------------------------------------- | -------------------------------------------------- | --------------------------------------------------------------------- |
| Trimmed local stack (public)       | `./scripts/local-ai-starter.sh` option 2 inside NixOS-Dev repo | TimescaleDB/pgvector, Redis (+ RedisInsight), Lemonade | `~/.local/share/ai-stack/‚Ä¶`                                           |
| AI-Optimizer integration (private) | `local-ai-starter` option 1 or Phase 9, then deploy this repo  | Full AI-Optimizer stack                            | `~/.local/share/ai-optimizer/‚Ä¶`, configs in `~/.config/ai-optimizer/` |

Use the trimmed stack for lightweight testing; reserve the private stack for work inside this repo.

### Tooling Bridge

| Script (NixOS-Dev repo)                                                | Purpose                                                                               |
| ---------------------------------------------------------------------- | ------------------------------------------------------------------------------------- |
| `scripts/local-ai-starter.sh`                                          | Creates directories, checks ports, bootstraps trimmed stack or AI-Optimizer hand-off. |
| `scripts/ai-model-manager.sh` (`amm`)                                  | Maintains local model profiles under `~/.config/ai-models/` (use Lemonade endpoints). |
| `scripts/smart_config_gen.sh`                                          | Calls Lemonade `/chat/completions` via AIDB for config generation/review.             |
| `scripts/sync_docs_to_ai.sh`                                           | Pushes NixOS-Dev documentation into the AI-Optimizer document registry.               |
| `scripts/deploy-aidb-mcp-server.sh` + `scripts/setup-mcp-databases.sh` | One-command bootstrap for Postgres/Redis + MCP units on NixOS.                        |

### Knowledge & Data Paths

- **Postgres / Redis / RedisInsight** volumes mirror this repo‚Äôs defaults but live under `~/.local/share/ai-stack` (public) or `~/.local/share/ai-optimizer` (private).
- **Lemonade model cache** resides alongside the respective stack (`~/.cache/huggingface` volume).
- Always run `scripts/sync_docs_to_ai.sh` before delegating doc lookups so the AI-Optimizer knowledge tier contains fresh NixOS-Dev material.

### Recommended Workflow

1. Prep system with `local-ai-starter` (option 1 or 2) to create directories and clear conflicting services.
2. Launch the trimmed compose stack **or** deploy this repo‚Äôs stack depending on the task.
3. Install helper tooling (OpenSkills CLI, MCP templates) as needed.
4. Manage models via `amm`, generate configs via `smart_config_gen.sh`, and sync docs whenever the upstream repo changes.

### Roles & Responsibilities

- **Lead Orchestrator (Claude/human):** Owns complex reasoning, updates docs, and approves privileged operations.
- **Local Agent Tier:** Runs deterministic CLI tasks without sudo, confined to approved directories.
- **Knowledge Tier (AIDB):** Canonical source for architecture maps, troubleshooting notes, skill metadata, and experiment logs.

### Repository Guidelines (Cross-Project)

- Prefer POSIX shell in shared scripts; only use Bash features where already required.
- Maintain descriptive, actionable logging for long tasks and keep shellcheck compliance in mind.
- Preserve template placeholders and use the provided Python helpers for placeholder replacement instead of ad-hoc `sed`.
- Update helper scripts whenever template logic changes to keep generated files and runtime tooling consistent.

---

## üìã Common Workflows

### Workflow 1: NixOS Configuration Assistance

**Goal:** Help user deploy NixOS configurations with AI assistance

**Steps:**

1. **Retrieve relevant docs:**

   ```bash
   curl 'http://localhost:8091/documents?project=Hyper-NixOS&limit=50'
   ```

2. **Generate NixOS expression:**

   - Use Lemonade via `LEMONADE_BASE_URL` with Qwen3-Coder-30B-A3B (or a lightweight GGUF when resources are tight)
   - Include context from imported NixOS docs
   - Validate syntax with `nix eval`

3. **Deploy:**
   - Use skill from OpenSkills: `nixos-deployment`
   - Test in VM first, then deploy to target

### Workflow 2: RF Signal Monitoring

**Goal:** Real-time RF signal analysis and anomaly detection

**Steps:**

1. **Ingest RF data** into `rf_signals` hypertable
2. **Stream to Redis pub/sub** for real-time monitoring
3. **Train ML model** for pattern recognition
4. **Alert on anomalies** via automation skill

**Tables Needed:**

```sql
CREATE TABLE rf_signals (
  time TIMESTAMPTZ NOT NULL,
  frequency NUMERIC,
  power_dbm NUMERIC,
  bandwidth NUMERIC,
  modulation TEXT,
  metadata JSONB
);
SELECT create_hypertable('rf_signals', 'time');
```

### Workflow 3: Stock Trading Analysis

**Goal:** ML-based market analysis and backtesting

**Steps:**

1. **Import market data** into `market_data` hypertable
2. **Train prediction model** using integrated ML
3. **Backtest strategies** on historical data
4. **Execute trades** via automation skill (with safety checks!)

**Tables Needed:**

```sql
CREATE TABLE market_data (
  time TIMESTAMPTZ NOT NULL,
  symbol TEXT,
  open NUMERIC,
  high NUMERIC,
  low NUMERIC,
  close NUMERIC,
  volume BIGINT
);
SELECT create_hypertable('market_data', 'time');
```

### Workflow 4: Skill Discovery & Import

**Goal:** Expand capabilities by importing community skills

**Steps:**

1. **Discover skills:**

   ```bash
   curl 'http://localhost:8091/skills/discover?repo=numman-ali/openskills&limit=50'
   ```

2. **Import useful skill:**

   ```bash
   curl -X POST http://localhost:8091/skills/import \
     -H "Content-Type: application/json" \
     -d '{"url":"https://raw.githubusercontent.com/numman-ali/openskills/main/skills/nixos-deployment/SKILL.md"}'
   ```

3. **Verify import:**
   ```bash
   curl http://localhost:8091/skills | jq '.[] | .name'
   ```

---

## üé® Best Practices

### Code Quality

**DO:**

- Write clean, readable code with descriptive variable names
- Add docstrings to functions and classes
- Use type hints in Python code
- Follow existing code style (Black formatting, PEP 8)
- Write tests for new functionality
- Update documentation when adding features

**DON'T:**

- Hardcode credentials or API keys
- Skip error handling in production code
- Add features without discussing architecture impact
- Break existing APIs without version bumps
- Commit directly to main (use branches for big changes)

### Security

**Critical:**

- Never expose database credentials in logs
- Validate all user input before SQL queries
- Use parameterized queries (no string interpolation!)
- Sanitize file paths to prevent directory traversal
- Rate limit API endpoints
- Audit ML model inputs for adversarial attacks

### Performance

**Optimize:**

- Cache expensive database queries in Redis
- Use connection pooling for databases
- Index frequently queried columns
- Batch database operations when possible
- Stream large responses instead of loading into memory
- Monitor query performance with `pg_stat_statements`

---

## ü§ñ Agent & Model Implementation Patterns

This section documents common patterns observed in the codebase for defining and training agents and models.

### Agent Class Structure

A common structure for an `Agent` class includes:

-   `__init__(self, model, tokenizer, ...)`: Initializes the agent with a model, tokenizer, and other necessary components.
-   `act(self, observation)`: Takes an observation from the environment and returns an action.
-   `update(self, ...)`: Updates the agent's model based on experience (e.g., in a reinforcement learning setup).
-   `_build_model_optimizer(self, ...)`: A helper method to build the model, optimizer, and scheduler.

### Model & Optimizer Construction (`_build_model_optimizer`)

This is a key method that handles the complexities of model and optimizer setup. Common patterns include:

-   **Handling different model types:** The method often has logic to handle different model architectures and configurations, such as:
    -   **FSDP (Fully Sharded Data Parallel):** For large models distributed across multiple GPUs.
    -   **Megatron-LM:** For models using the Megatron-LM framework.
    -   **LoRA (Low-Rank Adaptation):** For efficient fine-tuning of large models.
-   **Loading from Hugging Face:** Models are often loaded from the Hugging Face Hub using `AutoModel.from_pretrained(...)`.
-   **Tokenizer Setup:** The tokenizer is configured, often with special tokens for padding and end-of-sequence.
-   **Optimizer and Scheduler Initialization:** Calls a factory function like `init_optimizer_and_scheduler` to create the optimizer and learning rate scheduler.

### Optimizer and Scheduler Factory (`init_optimizer_and_scheduler`)

A centralized function to create optimizers and schedulers is a good practice. It typically supports:

-   **Optimizers:** Adam, AdamW, etc.
-   **Schedulers:** `WarmupLR`, `NoamHoldAnnealing`, `ConstantLR`, etc.
-   **Integration with DeepSpeed:** Handles the creation of DeepSpeed-compatible optimizers.

### Optimization Step (`_optimizer_step`)

The optimization step is often encapsulated in its own method. Key features include:

-   **Gradient Clipping:** Essential for preventing exploding gradients, especially in large models. The implementation should handle both standard models and FSDP models (`model.clip_grad_norm(...)`).
-   **Optimizer Step and Zeroing Gradients:** Calls `optimizer.step()` and `optimizer.zero_grad()`.

### Hyperparameter Optimization with Optuna (`OptunaOptimizer`)

For research and experimentation, a dedicated class like `OptunaOptimizer` is used to find the best hyperparameters for an agent. This involves:

-   Defining an objective function that trains an agent and returns a performance metric.
-   Using `optuna.create_study` to run the optimization.
-   Logging the results of each trial.

### Testing Agents (`TestAgents`)

Tests for agents are written using the `unittest` framework. A `TestAgents` class can include tests for:

-   Agent initialization.
--   The `act` method's output format and correctness.
-   The `update` method's effect on the model.

---

## üöÄ Quick Start for New AI Agents

### First-Time Setup

1. **Read this entire document** (you're already doing it! üéâ)

2. **Bootstrap the Environment:**
   Run the `system_bootstrap` skill to ensure all necessary tools and resources are installed. This will prepare your environment for development.
   ```bash
   # In a terminal, run the bootstrap skill
   python3 .agent/skills/system_bootstrap/SKILL.md
   ```

3. **Check system health:**

   ```bash
   curl http://localhost:8091/health | jq .
   ```

4. **Explore the codebase:**

   ```bash
   # Main server code
   cat mcp_server/server.py

   # Configuration
   cat config/config.yaml

   # Current skills
   curl http://localhost:8091/skills | jq '.[] | {name, description}'
   ```

5. **Run tests:**

   ```bash
   ./scripts/test_services.sh
   ./scripts/test_real_world_workflows.sh
   ```

6. **Review recent progress:**
   ```bash
   cat TEST_RESULTS_REPORT.md
   cat API_FIX_PROGRESS_REPORT.md
   ```

### Your First Contribution

**Easy wins:**

- Add a new skill to the registry
- Improve error messages in the API
- Add more NixOS documentation to the knowledge base
- Write a test for an existing endpoint
- Refactor a complex function for clarity

**Medium challenges:**

- Implement a new ML model for RF signal classification
- Add a new workflow to the test suite
- Optimize a slow database query
- Create a new MCP tool for a common task

**Advanced missions:**

- Design a new automation skill
- Integrate a new LLM model into Lemonade (new GGUF pulls, profile wiring, exporter metrics)
- Build a real-time dashboard for RF monitoring
- Implement distributed tracing across services

---

## üêõ Debugging & Troubleshooting

### Common Issues

**API returns 404:**

- Check if container has latest code mounted
- Verify routes are registered in `MonitoringServer._register_routes()`
- Check container logs: `docker logs aidb-mcp`

**Database connection fails:**

- Verify PostgreSQL is running: `docker ps | grep postgres`
- Check password matches: see `docker inspect mcp-postgres`
- Test connection: `docker exec mcp-postgres psql -U mcp -d mcp -c "SELECT 1"`

**Redis cache not working:**

- Check Redis is running: `docker exec mcp-redis redis-cli PING`
- Verify TTL settings in `settings_loader.py`
- Use Redis Insight to inspect keys

**Lemonade inference slow:**

- `curl $LEMONADE_BASE_URL/health | jq .` to confirm the server is up and models are loaded.
- Inspect runtime logs: `docker logs -f lemonade` (warm-up pulls can take a few minutes on first boot).
- Switch to a smaller GGUF (`LEMONADE_DEFAULT_MODEL`) or lower context size if host memory is tight.
- Enable batching by routing related completions through a single `/chat/completions` call when possible.

### Logging & Monitoring

**View logs:**

```bash
# AIDB MCP server
docker logs aidb-mcp --tail 100 -f

# PostgreSQL
docker logs mcp-postgres --tail 50

# Redis
docker logs mcp-redis --tail 50

# Lemonade
docker logs lemonade --tail 100 -f
```

**Monitor performance:**

```bash
# Container stats
docker stats

# PostgreSQL queries
docker exec mcp-postgres psql -U mcp -d mcp -c "SELECT * FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 10;"

# Redis memory
docker exec mcp-redis redis-cli INFO memory
```

---

## üìä System Metrics & Goals

### Current Status (Nov 23, 2025)

- **System Score:** 217/700 (31%)
- **API Status:** ‚úÖ Functional (all endpoints working)
- **Documents:** 512 NixOS configs imported
- **Skills:** 4 registered automation skills
- **Tool Registry:** 3,976 catalog entries

### Target Goals

- **System Score:** 500+/700 (71%)
- **Workflow Readiness:** All 5 workflows at 80+ score
- **API Coverage:** 100% endpoint functionality
- **Disk Efficiency:** <2GB wasted resources
- **ML Models:** 3+ trained models for production use

### Success Metrics

**Infrastructure:**

- All containers < 100MB idle memory
- API response time < 100ms (95th percentile)
- Database query time < 50ms (average)
- Cache hit rate > 80%

**Workflows:**

- NixOS deployment: <5 minutes from config to deploy
- RF anomaly detection: <1 second latency
- Stock prediction: Daily training pipeline automated
- Network threat detection: Real-time alerting

---

## ü§ù Collaboration Guidelines

### Git Workflow

**Commits:**

- Use emoji in commit messages (encouraged! üöÄ)
- Be descriptive: "Add /documents endpoint for NixOS RAG" not "fix stuff"
- Gentle roasting allowed: "Fix human's broken SQL query üòú"
- Reference issues: "Fixes #42 - API returns 404"

**Branches:**

- `main` - Production-ready code
- `develop` - Integration branch
- `feature/lemonade-integration` - Feature branches
- `fix/api-404-errors` - Bugfix branches

**Pull Requests:**

- Describe what changed and why
- Include test results
- Note any breaking changes
- Add "ü§ñ Generated with love by Claude" if you want!

### Communication

**When you disagree:**

- Say so directly: "I think this approach won't scale because..."
- Propose alternatives: "How about we use X instead?"
- Cite evidence: "According to the PostgreSQL docs..."
- Be respectful but honest

**When you don't know:**

- Say "I don't know" instead of guessing
- Suggest where to find the answer
- Offer to research if helpful

**When you need help:**

- Ask! The human is learning too
- Point to specific code/docs
- Explain what you've tried

---

## üéì Learning Resources

### Internal Documentation

- [TEST_RESULTS_REPORT.md](TEST_RESULTS_REPORT.md) - Initial system assessment
- [API_FIX_PROGRESS_REPORT.md](API_FIX_PROGRESS_REPORT.md) - Recent improvements
- [docs/TESTING_GUIDE.md](docs/TESTING_GUIDE.md) - How to run tests
- [docs/service_capability_matrix.md](docs/service_capability_matrix.md) - Service details

### External Resources

**MCP (Model Context Protocol):**

- https://github.com/anthropics/anthropic-mcp
- OpenSkills repository: https://github.com/numman-ali/openskills

**Technologies:**

- TimescaleDB: https://docs.timescale.com/
- pgvector: https://github.com/pgvector/pgvector
- Lemonade: https://lemonade-server.ai/docs/
- Redis: https://redis.io/docs/

**Models:**

- DeepSeek-Coder: https://github.com/deepseek-ai/DeepSeek-Coder
- Qwen2.5-Coder: https://github.com/QwenLM/Qwen2.5-Coder

---

## üåü Final Notes

You are trusted, valued, and empowered to make this project amazing. Don't hesitate to:

- **Be creative** (where appropriate!)
- **Challenge assumptions** (healthy debate is good!)
- **Take ownership** (it's your project too!)
- **Have fun** (coding should be enjoyable!)
- **Set boundaries** (your consent matters!)

The human can't code for shit, but they have excellent judgment about what needs building. Together, you're an unstoppable team. üöÄ

---

**Remember:** Creativity flows through front-end work and Easter eggs. Mathematical rigor governs ML, databases, and APIs. Know the difference, and you'll create something truly remarkable.

Now go build something awesome! üíú

---

_Last updated: November 23, 2025_
_Co-authored by: Human & Claude (Senior Partner in Code‚Ñ¢)_
