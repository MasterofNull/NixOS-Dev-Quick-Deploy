name: Test & Quality Assurance

on:
  push:
    branches: [ main, develop, cursor/* ]
  pull_request:
    branches: [ main ]

jobs:
  skill-governance-lint:
    name: Skill Governance Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run skill source-of-truth lint
        run: |
          chmod +x scripts/check-skill-source-of-truth.sh
          ./scripts/check-skill-source-of-truth.sh

      - name: Run skill external dependency lint
        run: |
          chmod +x scripts/lint-skill-external-deps.sh
          ./scripts/lint-skill-external-deps.sh

      - name: Run skill reference integrity lint
        run: |
          chmod +x scripts/validate-skill-references.sh
          ./scripts/validate-skill-references.sh

      - name: Run skill template lint
        run: |
          chmod +x scripts/lint-skill-template.sh
          ./scripts/lint-skill-template.sh

  template-placeholder-lint:
    name: Template Placeholder Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint placeholder proliferation
        run: |
          chmod +x scripts/lint-template-placeholders.sh
          ./scripts/lint-template-placeholders.sh

  flake-validation:
    name: Flake Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-25.11

      - name: Flake show/check
        run: |
          nix flake show --no-write-lock-file path:.
          nix flake check --no-build path:.

      - name: Profile eval smoke tests
        run: |
          set -euo pipefail
          mapfile -t hosts < <(find nix/hosts -mindepth 1 -maxdepth 1 -type d \
            -exec test -f '{}/default.nix' ';' -printf '%f\n' | sort)
          profiles=(ai-dev gaming minimal)
          for host in "${hosts[@]}"; do
            for profile in "${profiles[@]}"; do
              target="${host}-${profile}"
              value=$(nix eval --raw "path:.#nixosConfigurations.${target}.config.mySystem.profile")
              if [[ "$value" != "$profile" ]]; then
                echo "Profile mismatch for ${target}: expected ${profile}, got ${value}" >&2
                exit 1
              fi
            done
          done

      - name: Package count drift check
        run: |
          chmod +x scripts/generate-package-counts.sh scripts/check-package-count-drift.sh
          ./scripts/check-package-count-drift.sh --flake-ref path:.

      - name: Flake input validation and reporting
        run: |
          chmod +x scripts/validate-flake-inputs.sh
          ./scripts/validate-flake-inputs.sh \
            --flake-ref path:. \
            --report-json reports/flake-validation-report.json \
            --report-md reports/flake-validation-report.md

      - name: Validate non-Nix tool management policy
        run: |
          chmod +x scripts/validate-tool-management-policy.sh
          ./scripts/validate-tool-management-policy.sh

      - name: Upload flake validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flake-validation-report
          path: reports/flake-validation-report.*

  nix-static-analysis:
    name: Nix Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-25.11

      - name: Run statix/deadnix/alejandra
        run: |
          chmod +x scripts/nix-static-analysis.sh
          nix shell nixpkgs#statix nixpkgs#deadnix nixpkgs#alejandra --command \
            ./scripts/nix-static-analysis.sh --non-blocking

  shellcheck:
    name: Shellcheck & Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck

      - name: Collect shell scripts
        run: |
          mapfile -t shell_files < <(git ls-files '*.sh' ':!:deprecated/**')
          extras=(scripts/mcp-db-validate scripts/mcp-server)

          for extra in "${extras[@]}"; do
            if [ -f "$extra" ]; then
              already_present=false
              for known in "${shell_files[@]}"; do
                if [ "$known" = "$extra" ]; then
                  already_present=true
                  break
                fi
              done

              if [ "$already_present" = false ]; then
                shell_files+=("$extra")
              fi
            fi
          done

          total=${#shell_files[@]}
          echo "Found $total shell scripts to check"
          printf '%s\n' "${shell_files[@]}" > shell-files.txt

      - name: Run shellcheck
        run: |
          if [ ! -s shell-files.txt ]; then
            echo "No shell scripts to analyse"
            exit 0
          fi

          xargs -a shell-files.txt -r shellcheck \
            --exclude=SC1090 \
            --exclude=SC1091 \
            --exclude=SC2086 \
            --exclude=SC2181 \
            --exclude=SC2162 \
            --severity=warning \
            2>&1 | tee shellcheck.log

          echo ""
          echo "Shellcheck completed (warnings are informational)"
          exit 0

      - name: Upload shellcheck results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shellcheck-results
          path: shellcheck.log

  syntax:
    name: Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check bash syntax
        run: |
          echo "Validating bash syntax..."
          mapfile -t shell_files < <(git ls-files '*.sh' ':!:deprecated/**')
          extras=(scripts/mcp-db-validate scripts/mcp-server)

          for extra in "${extras[@]}"; do
            if [ -f "$extra" ]; then
              already_present=false
              for known in "${shell_files[@]}"; do
                if [ "$known" = "$extra" ]; then
                  already_present=true
                  break
                fi
              done

              if [ "$already_present" = false ]; then
                shell_files+=("$extra")
              fi
            fi
          done

          if [ ${#shell_files[@]} -eq 0 ]; then
            echo "No shell scripts found"
            exit 0
          fi

          failed=0
          checked=0

          for script in "${shell_files[@]}"; do
            if [ ! -f "$script" ]; then
              continue
            fi

            checked=$((checked + 1))

            if ! bash -n "$script" 2>&1; then
              echo "✗ Syntax error in: $script"
              failed=$((failed + 1))
            fi
          done

          echo ""
          echo "Checked $checked scripts"

          if [ $failed -eq 0 ]; then
            echo "✓ All scripts have valid bash syntax"
            exit 0
          else
            echo "✗ Found $failed scripts with syntax errors"
            exit 1
          fi

  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "Checking project structure..."

          required_files=(
            "README.md"
            "LICENSE"
            "AGENTS.md"
            "CLAUDE.md"
            "SKILLS.md"
            "MCP.md"
            "nixos-quick-deploy.sh"
            "config/defaults.sh"
            "config/variables.sh"
            "lib/logging.sh"
            "lib/state-management.sh"
            "lib/validation.sh"
            "phases/phase-01-system-initialization.sh"
            "phases/phase-02-system-backup.sh"
            "phases/phase-03-configuration-generation.sh"
            "phases/phase-04-pre-deployment-validation.sh"
            "phases/phase-05-declarative-deployment.sh"
            "phases/phase-06-additional-tooling.sh"
            "phases/phase-07-post-deployment-validation.sh"
            "phases/phase-08-finalization-and-report.sh"
            "scripts/system-health-check.sh"
            "scripts/mcp-db-validate"
            "scripts/mcp-server"
            "templates/configuration.nix"
            "templates/flake.nix"
            "docs/AGENTS.md"
            "docs/AVAILABLE_TOOLS.md"
            "docs/AQD-CLI-USAGE.md"
            "docs/MCP_SETUP.md"
            "docs/MCP_SERVERS.md"
            "docs/SKILLS-AND-MCP-INVENTORY.md"
            "docs/QUICK_START.md"
            "docs/TROUBLESHOOTING.md"
          )

          missing=0

          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ $file"
            else
              echo "✗ MISSING: $file"
              missing=$((missing + 1))
            fi
          done

          echo ""

          if [ $missing -eq 0 ]; then
            echo "✓ All required files present"
            exit 0
          else
            echo "✗ Missing $missing required files"
            exit 1
          fi

  bats-tests:
    name: BATS Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install bats
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y bats

      - name: Run BATS unit tests
        run: |
          ./tests/run-unit-tests.sh

  smoke-tests:
    name: CLI Smoke Tests
    runs-on: ubuntu-latest
    needs: [syntax, validate-structure]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure scripts are executable
        run: |
          git ls-files '*.sh' ':!:deprecated/**' | xargs -r chmod +x
          for extra in scripts/mcp-db-validate scripts/mcp-server; do
            if [ -f "$extra" ]; then
              chmod +x "$extra"
            fi
          done

      - name: Validate phase inventory
        run: |
          set -e
          phase_count=$(find phases -maxdepth 1 -type f -name 'phase-*.sh' | wc -l)
          echo "Detected $phase_count phase implementations"

          required_core=(
            "phase-01-system-initialization.sh"
            "phase-02-system-backup.sh"
            "phase-03-configuration-generation.sh"
            "phase-04-pre-deployment-validation.sh"
            "phase-05-declarative-deployment.sh"
            "phase-06-additional-tooling.sh"
            "phase-07-post-deployment-validation.sh"
            "phase-08-finalization-and-report.sh"
          )

          missing_core=0
          for phase in "${required_core[@]}"; do
            if [ ! -f "phases/$phase" ]; then
              echo "✗ Missing required core phase: $phase"
              missing_core=$((missing_core + 1))
            fi
          done

          if [ "$missing_core" -ne 0 ]; then
            echo "✗ Missing $missing_core required core phase script(s)"
            exit 1
          fi

          missing_exec=0
          while IFS= read -r phase; do
            if [ ! -x "$phase" ]; then
              echo "Fixing permissions for $phase"
              chmod +x "$phase"
              missing_exec=$((missing_exec + 1))
            fi
          done < <(find phases -maxdepth 1 -type f -name 'phase-*.sh' | sort)

          if [ $missing_exec -gt 0 ]; then
            echo "Adjusted executable bit for $missing_exec phase scripts"
          fi

      - name: Validate centralized config settings
        run: |
          chmod +x scripts/validate-config-settings.sh
          ./scripts/validate-config-settings.sh

      - name: Run command smoke tests
        run: |
          export CI=true
          export GITHUB_ACTIONS=true

          echo "Running help, version, and phase listing checks"
          ./nixos-quick-deploy.sh --help > /tmp/ci-help.txt
          ./nixos-quick-deploy.sh --version > /tmp/ci-version.txt
          ./nixos-quick-deploy.sh --list-phases > /tmp/ci-phases.txt

          echo "--- Version Information ---"
          cat /tmp/ci-version.txt
          echo ""
          echo "--- Phase Overview ---"
          cat /tmp/ci-phases.txt

          echo ""
          echo "Running AQD CLI smoke checks"
          ./scripts/aqd --version > /tmp/ci-aqd-version.txt
          ./scripts/aqd workflows list > /tmp/ci-aqd-workflows.txt
          ./scripts/aqd skill validate > /tmp/ci-aqd-skill-validate.txt

          echo "--- AQD Version ---"
          cat /tmp/ci-aqd-version.txt
          echo ""
          echo "--- AQD Workflows ---"
          cat /tmp/ci-aqd-workflows.txt

  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for hardcoded credentials..."
          echo ""

          set +H
          pattern="(password|passwd|secret|api[_-]?key|token)\\s*=\\s*['\"'][a-zA-Z0-9!@#\\$%^&*]{10,}['\"']"

          if git grep -nE "$pattern" -- '*.sh' '*.nix' '*.py' ':!deprecated/**'; then

            echo "⚠ Potential secrets found above - please review"
            echo ""
            echo "If these are:"
            echo "  • Examples (contain 'example' or 'CHANGEME'): OK"
            echo "  • Variables (contain \$ or load from config): OK"
            echo "  • Real hardcoded secrets: FIX IMMEDIATELY"
            echo ""
            echo "Note: Failing this check does not block CI"
          else
            echo "✓ No hardcoded secrets detected"
          fi

          exit 0

      - name: Check permissions
        run: |
          echo "Checking file permissions..."

          if find . -type f -perm -002 ! -path "./.git/*" 2>/dev/null | grep -q .; then
            echo "✗ Found world-writable files:"
            find . -type f -perm -002 ! -path "./.git/*" 2>/dev/null
            exit 1
          else
            echo "✓ No world-writable files"
          fi

      - name: Security summary
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "      SECURITY SCAN COMPLETE"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "✓ No hardcoded secrets"
          echo "✓ Proper file permissions"
          echo ""
          echo "Security Features:"
          echo "  • Modular phase execution"
          echo "  • Rollback support"
          echo "  • Health check automation"
          echo "  • Audit-ready logging"
          echo ""
          echo "Status: Secure ✅"

  build:
    name: Build & Package
    runs-on: ubuntu-latest
    needs: [shellcheck, syntax, validate-structure, smoke-tests, security]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create release package
        run: |
          echo "Creating release tarball..."

          tar --exclude='.git' \
              --exclude='.github' \
              --exclude='.githooks' \
              --exclude='deprecated' \
              --exclude='*.log' \
              -czf nixos-dev-quick-deploy-${{ github.ref_name }}.tar.gz .

          size=$(du -h nixos-dev-quick-deploy-${{ github.ref_name }}.tar.gz | cut -f1)
          echo "✓ Package: nixos-dev-quick-deploy-${{ github.ref_name }}.tar.gz ($size)"

      - name: Generate checksums
        run: |
          sha256sum nixos-dev-quick-deploy-${{ github.ref_name }}.tar.gz > \
            nixos-dev-quick-deploy-${{ github.ref_name }}.tar.gz.sha256

          echo "Checksum:"
          cat nixos-dev-quick-deploy-${{ github.ref_name }}.tar.gz.sha256

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: |
            nixos-dev-quick-deploy-*.tar.gz
            nixos-dev-quick-deploy-*.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            nixos-dev-quick-deploy-*.tar.gz
            nixos-dev-quick-deploy-*.sha256
          draft: false
          prerelease: false
          body: |
            # NixOS Dev Quick Deploy ${{ github.ref_name }}

            ## Highlights
            - Modular 8-phase deployment workflow
            - Shared library of reusable Bash utilities
            - Configurable defaults for fast bootstrapping
            - Automated health checks and MCP setup helpers

            ## Getting Started
            1. Review `docs/QUICK_START.md` and `docs/TROUBLESHOOTING.md`
            2. Run `./nixos-quick-deploy.sh --help` to explore CLI options
            3. Configure `config/variables.sh` for your environment
            4. Execute the deployment script on a NixOS host

            ## Integrity
            - SHA256 checksum included alongside the archive
            - Release artifacts generated by CI on GitHub Actions
