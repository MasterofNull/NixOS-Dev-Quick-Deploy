name: Security Audit & Vulnerability Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security-audit:
    name: Security Configuration Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq yq
          pip install pyyaml

      - name: Run security audit script
        id: audit
        run: |
          bash scripts/security-audit.sh > security-audit-results.txt 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: security-audit-results.txt
          retention-days: 30

      - name: Check audit results
        run: |
          cat security-audit-results.txt
          if grep -q "BLOCKING" security-audit-results.txt; then
            echo "::error::Security audit found blocking failures"
            exit 1
          fi
          if grep -q "CRITICAL" security-audit-results.txt; then
            echo "::warning::Security audit found critical issues"
          fi

      - name: Comment PR with audit results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = fs.readFileSync('security-audit-results.txt', 'utf8');
            const body = `## Security Audit Results\n\n\`\`\`\n${results}\n\`\`\``;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  trivy-scan-core:
    name: Trivy Vulnerability Scan (Core Images)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - postgres:17-alpine
          - redis:7.4-alpine
          - qdrant/qdrant:v1.12.5
          - nginx:1.27-alpine
          - grafana/grafana:11.4.0
          - prom/prometheus:v3.1.0
          - jaegertracing/all-in-one:1.64.0
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: 'sarif'
          output: 'trivy-results-${{ hashFiles(matrix.image) }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities in base images
          ignore-unfixed: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ hashFiles(matrix.image) }}.sarif'
          category: trivy-${{ matrix.image }}

      - name: Run Trivy scanner (table output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

  trivy-scan-custom:
    name: Trivy Scan (Custom Images)
    runs-on: ubuntu-latest
    needs: security-audit
    strategy:
      fail-fast: false
      matrix:
        service:
          - aidb
          - embeddings-service
          - hybrid-coordinator
          - nixos-docs
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        id: build
        run: |
          docker build \
            -f ai-stack/mcp-servers/${{ matrix.service }}/Dockerfile \
            -t local/${{ matrix.service }}:scan \
            ai-stack/mcp-servers
          echo "image=local/${{ matrix.service }}:scan" >> $GITHUB_OUTPUT

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.build.outputs.image }}
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Report findings but keep CI non-blocking
          ignore-unfixed: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'
          category: trivy-custom-${{ matrix.service }}

      - name: Run Trivy scanner (table output)
        uses: aquasecurity/trivy-action@master
        if: always()
        with:
          image-ref: ${{ steps.build.outputs.image }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

  dockerfile-lint:
    name: Dockerfile Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install hadolint
        run: |
          HADOLINT_VERSION=v2.14.0
          curl -fsSL "https://github.com/hadolint/hadolint/releases/download/${HADOLINT_VERSION}/hadolint-Linux-x86_64" -o hadolint
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/hadolint

      - name: Run hadolint on all Dockerfiles
        run: |
          set -euo pipefail
          mapfile -t dockerfiles < <(find ai-stack/mcp-servers -mindepth 2 -maxdepth 2 -name Dockerfile | sort)

          if [ "${#dockerfiles[@]}" -eq 0 ]; then
            echo "No Dockerfiles found under ai-stack/mcp-servers"
            exit 0
          fi

          failed=0
          : > hadolint-results.txt
          for dockerfile in "${dockerfiles[@]}"; do
            echo "Linting ${dockerfile}" | tee -a hadolint-results.txt
            if ! hadolint --failure-threshold error "${dockerfile}" 2>&1 | tee -a hadolint-results.txt; then
              failed=1
            fi
            echo "" >> hadolint-results.txt
          done

          if [ "$failed" -ne 0 ]; then
            echo "Hadolint reported blocking issues."
            exit 1
          fi

      - name: Upload Hadolint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hadolint-results
          path: hadolint-results.txt

  secrets-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: >
            --redact
            --config .gitleaks.toml
            --report-format sarif
            --report-path gitleaks-security.sarif
            --no-git
            --exit-code 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Upload Gitleaks SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks-security.sarif
          category: gitleaks-security

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-audit, trivy-scan-core, trivy-scan-custom, dockerfile-lint, secrets-scan]
    if: always()
    steps:
      - name: Download audit results
        uses: actions/download-artifact@v4
        with:
          name: security-audit-results

      - name: Security Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Audit" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.security-audit.result }}" == "success" ]; then
            echo "âœ… Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Vulnerability Scans" >> $GITHUB_STEP_SUMMARY
          echo "- Core Images: ${{ needs.trivy-scan-core.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Custom Images: ${{ needs.trivy-scan-custom.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Additional Checks" >> $GITHUB_STEP_SUMMARY
          echo "- Dockerfile Lint: ${{ needs.dockerfile-lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Detection: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š See the Security tab for detailed vulnerability reports" >> $GITHUB_STEP_SUMMARY
