# HIPAA Compliance Alert Rules for Hospital AI Stack
# Per HIPAA Security Rule - Audit Controls and Monitoring Requirements
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-hipaa-alerts
  namespace: ai-stack
  labels:
    hipaa-compliance: required
data:
  hipaa-alerts.yml: |
    groups:
    - name: hipaa-security-monitoring
      interval: 30s
      rules:
      # Authentication & Access Control Alerts
      - alert: UnauthorizedAccessAttempts
        expr: rate(aidb_http_requests_total{status="401"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          hipaa_category: access_control
        annotations:
          summary: "Potential unauthorized access attempts detected"
          description: "More than 0.1 req/s returning 401 Unauthorized on AIDB"
          action: "Review access logs, verify API key validity, check for brute force attempts"

      - alert: HighErrorRate
        expr: rate(aidb_http_requests_total{status=~"5.."}[5m]) / rate(aidb_http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          hipaa_category: integrity
        annotations:
          summary: "High error rate detected on AIDB service"
          description: "More than 5% of requests returning 5xx errors"

      # Service Availability Alerts (Required for HIPAA availability controls)
      - alert: ServiceDown
        expr: up{job="ai-stack"} == 0
        for: 1m
        labels:
          severity: critical
          hipaa_category: availability
        annotations:
          summary: "AI Stack service is down"
          description: "{{ $labels.instance }} has been unreachable for more than 1 minute"

      - alert: CircuitBreakerOpen
        expr: aidb_circuit_breaker_state != 0
        for: 5m
        labels:
          severity: warning
          hipaa_category: availability
        annotations:
          summary: "Circuit breaker is open - service degradation"
          description: "Circuit breaker for {{ $labels.dependency }} is not in CLOSED state"

      # Audit Logging Alerts (HIPAA Audit Controls)
      - alert: AuditLoggingUnavailable
        expr: absent(up{job="loki"}) == 1 or up{job="loki"} == 0
        for: 5m
        labels:
          severity: critical
          hipaa_category: audit_controls
        annotations:
          summary: "Audit logging service unavailable - HIPAA violation risk"
          description: "Loki log aggregation is down - all PHI access events may be untracked"
          action: "Immediately restore Loki service; document gap in audit trail"

      - alert: PromtailDown
        expr: absent(up{job="promtail"}) == 1 or up{job="promtail"} == 0
        for: 5m
        labels:
          severity: critical
          hipaa_category: audit_controls
        annotations:
          summary: "Log shipper unavailable - audit gap risk"
          description: "Promtail is not running - container logs are not being collected"

      # Resource Monitoring (System Integrity)
      - alert: HighMemoryUsage
        expr: (aidb_process_memory_bytes / 1024 / 1024) > 1024
        for: 10m
        labels:
          severity: warning
          hipaa_category: integrity
        annotations:
          summary: "High memory usage on AIDB"
          description: "AIDB using more than 1GB memory - potential memory leak or overload"

      - alert: EmbeddingsModelNotLoaded
        expr: absent(embeddings_model_load_seconds) == 1
        for: 5m
        labels:
          severity: warning
          hipaa_category: availability
        annotations:
          summary: "Embeddings model may not be loaded"
          description: "No model load metrics detected - semantic search may be unavailable"

      # Database Health (Data Integrity)
      - alert: DatabasePoolExhausted
        expr: aidb_db_pool_checked_out >= aidb_db_pool_size
        for: 5m
        labels:
          severity: warning
          hipaa_category: availability
        annotations:
          summary: "Database connection pool exhausted"
          description: "All database connections in use - new requests may fail"

      - alert: RedisPoolHighUtilization
        expr: aidb_redis_pool_in_use / aidb_redis_pool_max_connections > 0.8
        for: 10m
        labels:
          severity: warning
          hipaa_category: availability
        annotations:
          summary: "Redis connection pool at high utilization"
          description: "Redis pool over 80% utilized - may impact caching performance"

      # Backup Monitoring
      - alert: BackupJobFailed
        expr: kube_job_status_failed{namespace="backups"} > 0
        for: 1m
        labels:
          severity: critical
          hipaa_category: integrity
        annotations:
          summary: "Backup job failed"
          description: "A backup CronJob has failed - data protection compromised"
          action: "Check backup job logs, verify storage availability, re-run backup"

    - name: hipaa-performance-monitoring
      interval: 1m
      rules:
      - alert: HighLatency
        expr: histogram_quantile(0.99, rate(aidb_http_request_latency_seconds_bucket[5m])) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High API latency detected"
          description: "99th percentile latency exceeds 5 seconds"

      - alert: LLMInferenceUnavailable
        expr: absent(up{instance=~".*llama-cpp.*"}) == 1
        for: 5m
        labels:
          severity: critical
          hipaa_category: availability
        annotations:
          summary: "Local LLM inference service unavailable"
          description: "llama-cpp is not responding - AI capabilities degraded"
