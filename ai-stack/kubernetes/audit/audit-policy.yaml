# Kubernetes Audit Policy for HIPAA Compliance
# Per HIPAA Security Rule ยง164.312(b) - Audit Controls
# This policy tracks access to PHI-related resources
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
  # Log all access to secrets at RequestResponse level (critical for PHI)
  - level: RequestResponse
    resources:
      - group: ""
        resources: ["secrets"]
    namespaces: ["ai-stack", "logging", "backups"]

  # Log all ConfigMap access (may contain connection strings)
  - level: RequestResponse
    resources:
      - group: ""
        resources: ["configmaps"]
    namespaces: ["ai-stack"]

  # Log pod exec commands (potential PHI access)
  - level: RequestResponse
    resources:
      - group: ""
        resources: ["pods/exec", "pods/attach", "pods/portforward"]
    namespaces: ["ai-stack"]

  # Log all authentication events
  - level: Metadata
    users: ["system:anonymous"]
    verbs: ["*"]

  # Log service account token requests
  - level: Metadata
    resources:
      - group: ""
        resources: ["serviceaccounts/token"]

  # Log RBAC changes (security configuration)
  - level: RequestResponse
    resources:
      - group: "rbac.authorization.k8s.io"
        resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]

  # Log network policy changes
  - level: RequestResponse
    resources:
      - group: "networking.k8s.io"
        resources: ["networkpolicies"]

  # Log all deployment changes in ai-stack
  - level: Metadata
    resources:
      - group: "apps"
        resources: ["deployments", "statefulsets", "daemonsets"]
    namespaces: ["ai-stack"]
    verbs: ["create", "update", "patch", "delete"]

  # Log persistent volume access (data storage)
  - level: Metadata
    resources:
      - group: ""
        resources: ["persistentvolumeclaims", "persistentvolumes"]

  # Log namespace changes
  - level: Metadata
    resources:
      - group: ""
        resources: ["namespaces"]
    verbs: ["create", "delete"]

  # Catch-all for ai-stack namespace at Metadata level
  - level: Metadata
    namespaces: ["ai-stack"]

  # Don't log read-only requests to common resources
  - level: None
    resources:
      - group: ""
        resources: ["events", "nodes/status", "pods/status"]
    verbs: ["get", "list", "watch"]

  # Don't log health checks
  - level: None
    users: ["system:kube-proxy", "system:serviceaccount:kube-system:*"]
    verbs: ["get", "list", "watch"]

  # Don't log requests to non-resource URLs
  - level: None
    nonResourceURLs:
      - "/healthz*"
      - "/version"
      - "/swagger*"
      - "/metrics"

  # Default: log at Metadata level
  - level: Metadata
