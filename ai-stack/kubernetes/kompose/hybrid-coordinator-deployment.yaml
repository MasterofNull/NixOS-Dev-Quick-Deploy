apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.version: 1.37.0 (HEAD)
    nixos.quick-deploy.ai-stack: "true"
    nixos.quick-deploy.service: hybrid-coordinator
  labels:
    io.kompose.service: hybrid-coordinator
  name: hybrid-coordinator
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: hybrid-coordinator
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        kompose.version: 1.37.0 (HEAD)
        nixos.quick-deploy.ai-stack: "true"
        nixos.quick-deploy.service: hybrid-coordinator
        prometheus.io/scrape: "true"
        prometheus.io/port: "8092"
        prometheus.io/path: "/metrics"
      labels:
        io.kompose.service: hybrid-coordinator
    spec:
      serviceAccountName: hybrid-coordinator
      automountServiceAccountToken: false
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          command:
            - sh
            - -c
            - until nc -z postgres 5432; do echo "waiting for postgres"; sleep 2; done
        - name: wait-for-redis
          image: busybox:1.36
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          command:
            - sh
            - -c
            - until nc -z redis 6379; do echo "waiting for redis"; sleep 2; done
        - name: wait-for-qdrant
          image: busybox:1.36
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          command:
            - sh
            - -c
            - until nc -z qdrant 6333; do echo "waiting for qdrant"; sleep 2; done
        - name: wait-for-embeddings
          image: busybox:1.36
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          command:
            - sh
            - -c
            - until nc -z embeddings 8081; do echo "waiting for embeddings"; sleep 2; done
        - name: wait-for-aidb
          image: busybox:1.36
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          command:
            - sh
            - -c
            - until nc -z aidb 8091; do echo "waiting for aidb"; sleep 2; done
      containers:
        - env:
            - name: EMBEDDING_DIMENSIONS
              value: "384"
            - name: EMBEDDING_SERVICE_URL
              value: http://embeddings:8081
            - name: HYBRID_API_KEY
            - name: HYBRID_API_KEY_FILE
              value: /run/secrets/hybrid-coordinator-api-key
            - name: HYBRID_CONFIG
              value: /app/config/config.yaml
            - name: HYBRID_TELEMETRY_PATH
              value: /data/telemetry/hybrid-events.jsonl
            - name: MCP_SERVER_MODE
              value: http
            - name: MCP_SERVER_PORT
              value: "8092"
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: http://jaeger:4317
            - name: OTEL_TRACES_SAMPLER
              value: parentbased_traceidratio
            - name: OTEL_TRACES_SAMPLER_ARG
              value: "1.0"
            - name: OTEL_TRACING_ENABLED
              value: "true"
            - name: POSTGRES_DB
              value: mcp
            - name: POSTGRES_HOST
              value: postgres.ai-stack.svc.cluster.local
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: postgres-password
                  name: postgres-password
            - name: POSTGRES_USER
              value: mcp
            - name: QDRANT_API_KEY
            - name: QDRANT_HNSW_EF_CONSTRUCT
              value: "64"
            - name: QDRANT_HNSW_FULL_SCAN_THRESHOLD
              value: "10000"
            - name: QDRANT_HNSW_M
              value: "16"
            - name: QDRANT_URL
              value: http://qdrant:6333
            - name: REDIS_URL
              value: redis://redis.ai-stack.svc.cluster.local:6379
            - name: STACK_ENV
            - name: TELEMETRY_PATH
              value: /data/telemetry/hybrid-events.jsonl
          envFrom:
            - configMapRef:
                name: env
            - secretRef:
                name: huggingface-hub-token
          image: localhost:5000/ai-stack-hybrid-coordinator:dev
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          imagePullPolicy: Always
          livenessProbe:
            exec:
              command:
                - python
                - -c
                - import urllib.request; r=urllib.request.urlopen('http://localhost:8092/health', timeout=5); body=r.read().decode(); import sys; sys.exit(0 if '"status"' in body else 1)
            failureThreshold: 5
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
          startupProbe:
            exec:
              command:
                - python
                - -c
                - import urllib.request; r=urllib.request.urlopen('http://localhost:8092/health', timeout=5); body=r.read().decode(); import sys; sys.exit(0 if '"status"' in body else 1)
            failureThreshold: 30
            periodSeconds: 10
            timeoutSeconds: 5
          name: local-ai-hybrid-coordinator
          ports:
            - containerPort: 8092
              protocol: TCP
          resources:
            limits:
              cpu: "2"
              memory: "1610612736"
            requests:
              cpu: 500m
              memory: "536870912"
          volumeMounts:
            - mountPath: /run/secrets/hybrid-coordinator-api-key
              name: hybrid-coordinator-api-key
              subPath: hybrid-coordinator-api-key
            - mountPath: /run/secrets/embeddings_api_key
              name: embeddings-api-key
              subPath: embeddings_api_key
            - mountPath: /run/secrets/postgres-password
              name: postgres-password
              subPath: postgres-password
            - mountPath: /data/telemetry
              name: hybrid-coordinator-cm1
            - mountPath: /data/fine-tuning
              name: hybrid-coordinator-cm2
      restartPolicy: Always
      volumes:
        - name: hybrid-coordinator-api-key
          secret:
            defaultMode: 292
            items:
              - key: hybrid-coordinator-api-key
                path: hybrid-coordinator-api-key
            secretName: hybrid-coordinator-api-key
        - name: postgres-password
          secret:
            items:
              - key: postgres-password
                path: postgres-password
            secretName: postgres-password
        - name: embeddings-api-key
          secret:
            items:
              - key: embeddings_api_key
                path: embeddings_api_key
            secretName: embeddings-api-key
        - name: hybrid-coordinator-cm1
          emptyDir: {}
        - configMap:
            name: hybrid-coordinator-cm2
          name: hybrid-coordinator-cm2
